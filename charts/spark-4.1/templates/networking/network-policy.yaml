{{- if .Values.security.networkPolicies.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: spark-default-deny
  namespace: {{ .Release.Namespace }}
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: spark-connect-ingress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-connect
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          namespace: {{ .Release.Namespace }}
  ports:
  - protocol: TCP
    port: 15002
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: spark-connect-egress-api-server
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-connect
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        {}
  ports:
  - protocol: TCP
    port: 443
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: spark-connect-egress-dns
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-connect
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          k8s-app: kube-dns
  ports:
  - protocol: UDP
    port: 53
---
{{- if .Values.jupyter.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: jupyter-ingress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: jupyter
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          namespace: {{ .Release.Namespace }}
  ports:
  - protocol: TCP
    port: 8888
---
{{- end }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: s3-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-connect
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          app: minio
  ports:
  - protocol: TCP
    port: 9000
  - to:
    - podSelector:
        matchLabels:
          app: minio
  ports:
  - protocol: TCP
    port: 9000
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-connect
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          app: postgresql
  ports:
  - protocol: TCP
    port: 5432
---
{{- if .Values.hiveMetastore }}
{{- if .Values.hiveMetastore.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hive-metastore-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-connect
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          app: postgresql-hive
  ports:
  - protocol: TCP
    port: 5432
---
{{- end }}
{{- end }}
{{- if .Values.airflow }}
{{- if .Values.airflow.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: airflow-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-connect
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          app: airflow
  ports:
  - protocol: TCP
    port: 8080
---
{{- end }}
{{- end }}
{{- if .Values.sparkWorker }}
{{- if .Values.sparkWorker.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: spark-worker-communication
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: spark-worker
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: spark-connect
    - podSelector:
        matchLabels:
          app: spark-executor
  ports:
  - protocol: TCP
    port: 7777
  - protocol: TCP
    port: 7077
  - protocol: TCP
    port: 7078
  - Egress:
  - to:
    - podSelector:
        matchLabels:
          app: spark-connect
  ports:
  - protocol: TCP
    port: 7077
  - to:
    - podSelector:
        matchLabels:
          app: spark-executor
  ports:
  - protocol: TCP
    port: 7777
{{- end }}
{{- end }}
{{- end }}
