{{- /*
    Vault Agent template (HashiCorp Vault)
    Requires Vault installed and configured
*/ -}}
{{- if .Values.secrets.vault }}
{{- if .Values.secrets.vault.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: spark-vault-auth
  namespace: {{ .Release.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: spark-vault-auth
  namespace: {{ .Release.Namespace }}
rules:
- apiGroups:
  - "vault.coreos.com"
  resources:
  - "authroles"
  verbs:
  - "get"
  - "list"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: spark-vault-auth
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: spark-vault-auth
subjects:
- kind: ServiceAccount
  name: spark-vault-auth
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-agent-config
  namespace: {{ .Release.Namespace }}
data:
  vault-agent-config.hcl: |
    pid_file = "/tmp/vault-agent.pid"

    vault {
      address = {{ .Values.secrets.vault.address | quote }}
    }

    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = {{ .Values.secrets.vault.role | quote }}
        }
      }

      sink "file" {
        config = {
          path = "/tmp/vault-token"
        }
      }
    }

    template {
      source      = "/etc/vault/templates/s3-credentials.tpl"
      destination = "/etc/vault/secrets/s3-credentials"

      command     = "sleep 3600"
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: s3-credentials-from-vault
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  # This will be populated by Vault Agent
  access-key: ""
  secret-key: ""
{{- end }}
{{- end }}
