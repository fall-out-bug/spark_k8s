{{- if .Values.hiveMetastore.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore-db
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
type: Opaque
stringData:
  POSTGRES_USER: {{ .Values.global.postgresql.user | quote }}
  POSTGRES_PASSWORD: {{ .Values.global.postgresql.password | quote }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore-init
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app: hive-metastore
        {{- include "spark-4.1.selectorLabels" . | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "spark-4.1.serviceAccountName" . }}
      {{- if .Values.security.podSecurityStandards }}
      securityContext:
        {{- include "spark-base.podSecurityContext" . | nindent 8 }}
      {{- end }}
      containers:
        - name: schematool
          image: "{{ .Values.hiveMetastore.image.repository }}:{{ .Values.hiveMetastore.image.tag }}"
          imagePullPolicy: {{ .Values.hiveMetastore.image.pullPolicy }}
          env:
            - name: POSTGRES_HOST
              value: {{ .Values.global.postgresql.host | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.hiveMetastore.database.name | quote }}
          envFrom:
            - secretRef:
                name: {{ include "spark-4.1.fullname" . }}-metastore-db
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark-base.containerSecurityContext" . | nindent 12 }}
          {{- end }}
          command:
            - /bin/bash
            - -lc
            - |
              envsubst < /opt/hive/conf/hive-site.xml.template > /opt/hive/conf/hive-site.xml
              /opt/hive/bin/schematool -dbType postgres -initSchema --ifNotExists
          volumeMounts:
            - name: hive-config
              mountPath: /opt/hive/conf/hive-site.xml.template
              subPath: hive-site.xml.template
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: hive-config
          configMap:
            name: {{ include "spark-4.1.fullname" . }}-hive-metastore-config
        - name: tmp
          emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hive-metastore
      {{- include "spark-4.1.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        app: hive-metastore
        {{- include "spark-4.1.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "spark-4.1.serviceAccountName" . }}
      {{- if .Values.security.podSecurityStandards }}
      securityContext:
        {{- include "spark-base.podSecurityContext" . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: wait-for-postgresql
          image: busybox:1.36
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark-base.containerSecurityContext" . | nindent 12 }}
            runAsUser: 1000
            runAsGroup: 1000
          {{- end }}
          command:
            - sh
            - -c
            - >
              until nc -z {{ .Values.global.postgresql.host }} {{ .Values.global.postgresql.port }};
              do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"
      containers:
        - name: hive-metastore
          image: "{{ .Values.hiveMetastore.image.repository }}:{{ .Values.hiveMetastore.image.tag }}"
          imagePullPolicy: {{ .Values.hiveMetastore.image.pullPolicy }}
          env:
            - name: DB_DRIVER
              value: "postgres"
            - name: SERVICE_NAME
              value: "metastore"
            - name: POSTGRES_HOST
              value: {{ .Values.global.postgresql.host | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.hiveMetastore.database.name | quote }}
          envFrom:
            - secretRef:
                name: {{ include "spark-4.1.fullname" . }}-metastore-db
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark-base.containerSecurityContext" . | nindent 12 }}
          {{- end }}
          command:
            - /bin/bash
            - -lc
            - |
              envsubst < /opt/hive/conf/hive-site.xml.template > /opt/hive/conf/hive-site.xml
              exec /opt/hive/bin/hive --service metastore
          ports:
            - name: thrift
              containerPort: {{ .Values.hiveMetastore.service.port }}
          resources:
            {{- toYaml .Values.hiveMetastore.resources | nindent 12 }}
          volumeMounts:
            - name: hive-config
              mountPath: /opt/hive/conf/hive-site.xml.template
              subPath: hive-site.xml.template
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: hive-config
          configMap:
            name: {{ include "spark-4.1.fullname" . }}-hive-metastore-config
        - name: tmp
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
spec:
  selector:
    app: hive-metastore
    {{- include "spark-4.1.selectorLabels" . | nindent 4 }}
  ports:
    - name: thrift
      port: {{ .Values.hiveMetastore.service.port }}
      targetPort: thrift
{{- end }}
