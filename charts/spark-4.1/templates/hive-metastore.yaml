{{- if .Values.hiveMetastore.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "spark-4.1.fullname" . }}-hive-metastore-config
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
data:
  hive-site.xml.template: |
    <?xml version="1.0" encoding="UTF-8"?>
    <?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
    <configuration>
      <property>
        <name>javax.jdo.option.ConnectionURL</name>
        <value>jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}</value>
      </property>
      <property>
        <name>javax.jdo.option.ConnectionDriverName</name>
        <value>org.postgresql.Driver</value>
      </property>
      <property>
        <name>javax.jdo.option.ConnectionUserName</name>
        <value>${POSTGRES_USER}</value>
      </property>
      <property>
        <name>javax.jdo.option.ConnectionPassword</name>
        <value>${POSTGRES_PASSWORD}</value>
      </property>
      <property>
        <name>hive.metastore.uris</name>
        <value>thrift://{{ include "spark-4.1.fullname" . }}-metastore:{{ .Values.hiveMetastore.service.port }}</value>
      </property>
      <property>
        <name>hive.metastore.thrift.port</name>
        <value>{{ .Values.hiveMetastore.service.port }}</value>
      </property>
      <property>
        <name>hive.metastore.schema.verification</name>
        <value>false</value>
      </property>
    </configuration>
---
{{/* Secret for DB credentials */}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore-db
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
type: Opaque
stringData:
  POSTGRES_USER: {{ .Values.hiveMetastore.postgresql.username | quote }}
  POSTGRES_PASSWORD: {{ .Values.hiveMetastore.postgresql.password | quote }}
  POSTGRES_PORT: {{ .Values.hiveMetastore.postgresql.port | quote }}
---
{{/* Job for schema initialization */}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore-init
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ .Chart.Name }}-hive-metastore
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "spark-4.1.serviceAccountName" . }}
      {{- if .Values.security.podSecurityStandards }}
      securityContext:
        {{- include "spark-base.podSecurityContext" . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: wait-for-postgresql
          image: busybox:1.36
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark-base.containerSecurityContext" . | nindent 12 }}
            runAsUser: 1000
            runAsGroup: 1000
          {{- end }}
          command:
            - sh
            - -c
            - >
              until nc -z {{ .Values.hiveMetastore.postgresql.host }} {{ .Values.hiveMetastore.postgresql.port }};
              do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"
      containers:
        - name: schematool
          image: "{{ .Values.hiveMetastore.image.repository }}:{{ .Values.hiveMetastore.image.tag }}"
          imagePullPolicy: {{ .Values.hiveMetastore.image.pullPolicy }}
          env:
            - name: POSTGRES_HOST
              value: {{ .Values.hiveMetastore.postgresql.host | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.hiveMetastore.postgresql.port | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.hiveMetastore.postgresql.database | quote }}
            - name: HIVE_CONF_DIR
              value: "/tmp/hive-conf"
          envFrom:
            - secretRef:
                name: {{ include "spark-4.1.fullname" . }}-metastore-db
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark-base.containerSecurityContext" . | nindent 12 }}
          {{- end }}
          command:
            - /bin/bash
            - -lc
            - |
              # Generate hive-site.xml by substituting environment variables
              cat /opt/hive/conf/hive-site.xml.template | \
              sed "s/\${POSTGRES_HOST}/${POSTGRES_HOST}/g" | \
              sed "s/\${POSTGRES_PORT}/${POSTGRES_PORT}/g" | \
              sed "s/\${POSTGRES_DB}/${POSTGRES_DB}/g" | \
              sed "s/\${POSTGRES_USER}/${POSTGRES_USER}/g" | \
              sed "s#\${POSTGRES_PASSWORD}#${POSTGRES_PASSWORD}#g" \
              > /tmp/hive-conf/hive-site.xml
              /opt/hive/bin/schematool -dbType postgres -initSchema
          volumeMounts:
            - name: hive-config
              mountPath: /opt/hive/conf/hive-site.xml.template
              subPath: hive-site.xml.template
            - name: tmp
              mountPath: /tmp
            - name: hive-conf
              mountPath: /tmp/hive-conf
      volumes:
        - name: hive-config
          configMap:
            name: {{ include "spark-4.1.fullname" . }}-hive-metastore-config
        - name: tmp
          emptyDir: {}
        - name: hive-conf
          emptyDir: {}
---
{{/* Deployment for Hive Metastore */}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Chart.Name }}-hive-metastore
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ .Chart.Name }}-hive-metastore
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: {{ include "spark-4.1.serviceAccountName" . }}
      {{- if .Values.security.podSecurityStandards }}
      securityContext:
        {{- include "spark-base.podSecurityContext" . | nindent 8 }}
      {{- end }}
      initContainers:
        - name: wait-for-postgresql
          image: busybox:1.36
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark-base.containerSecurityContext" . | nindent 12 }}
            runAsUser: 1000
            runAsGroup: 1000
          {{- end }}
          command:
            - sh
            - -c
            - >
              until nc -z {{ .Values.hiveMetastore.postgresql.host }} {{ .Values.hiveMetastore.postgresql.port }};
              do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"
      containers:
        - name: hive-metastore
          image: "{{ .Values.hiveMetastore.image.repository }}:{{ .Values.hiveMetastore.image.tag }}"
          imagePullPolicy: {{ .Values.hiveMetastore.image.pullPolicy }}
          env:
            - name: DB_DRIVER
              value: "postgres"
            - name: SERVICE_NAME
              value: "metastore"
            - name: POSTGRES_HOST
              value: {{ .Values.hiveMetastore.postgresql.host | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.hiveMetastore.postgresql.port | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.hiveMetastore.postgresql.database | quote }}
            - name: HIVE_CONF_DIR
              value: "/tmp/hive-conf"
          envFrom:
            - secretRef:
                name: {{ include "spark-4.1.fullname" . }}-metastore-db
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark-base.containerSecurityContext" . | nindent 12 }}
          {{- end }}
          command:
            - /bin/bash
            - -lc
            - |
              # Generate hive-site.xml by substituting environment variables
              cat /opt/hive/conf/hive-site.xml.template | \
              sed "s/\${POSTGRES_HOST}/${POSTGRES_HOST}/g" | \
              sed "s/\${POSTGRES_PORT}/${POSTGRES_PORT}/g" | \
              sed "s/\${POSTGRES_DB}/${POSTGRES_DB}/g" | \
              sed "s/\${POSTGRES_USER}/${POSTGRES_USER}/g" | \
              sed "s#\${POSTGRES_PASSWORD}#${POSTGRES_PASSWORD}#g" \
              > /tmp/hive-conf/hive-site.xml
              exec /opt/hive/bin/hive --service metastore
          ports:
            - name: thrift
              containerPort: {{ .Values.hiveMetastore.service.port }}
          resources:
            {{- toYaml .Values.hiveMetastore.resources | nindent 12 }}
          volumeMounts:
            - name: hive-config
              mountPath: /opt/hive/conf/hive-site.xml.template
              subPath: hive-site.xml.template
            - name: tmp
              mountPath: /tmp
            - name: hive-conf
              mountPath: /tmp/hive-conf
      volumes:
        - name: hive-config
          configMap:
            name: {{ include "spark-4.1.fullname" . }}-hive-metastore-config
        - name: tmp
          emptyDir: {}
        - name: hive-conf
          emptyDir: {}
---
{{/* Service for Hive Metastore */}}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "spark-4.1.fullname" . }}-metastore
  labels:
    app: hive-metastore
    {{- include "spark-4.1.labels" . | nindent 4 }}
spec:
  selector:
    app.kubernetes.io/name: {{ .Chart.Name }}-hive-metastore
    app.kubernetes.io/instance: {{ .Release.Name }}
  ports:
    - name: thrift
      port: {{ .Values.hiveMetastore.service.port }}
      targetPort: thrift
{{- end }}
