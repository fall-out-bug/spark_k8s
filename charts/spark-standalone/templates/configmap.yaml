apiVersion: v1
kind: ConfigMap
metadata:
  name: spark-config
  labels:
    {{- include "spark-standalone.labels" . | nindent 4 }}
data:
  spark-defaults.conf: |
    # Standalone master settings
    spark.master=spark://{{ include "spark-standalone.fullname" . }}-master:{{ .Values.sparkMaster.service.ports.spark }}

    # S3A Configuration (Hadoop AWS)
    spark.hadoop.fs.s3a.impl=org.apache.hadoop.fs.s3a.S3AFileSystem
    spark.hadoop.fs.s3a.endpoint={{ .Values.s3.endpoint }}
    spark.hadoop.fs.s3a.access.key={{ .Values.s3.accessKey }}
    spark.hadoop.fs.s3a.secret.key={{ .Values.s3.secretKey }}
    spark.hadoop.fs.s3a.path.style.access={{ .Values.s3.pathStyleAccess }}
    spark.hadoop.fs.s3a.connection.ssl.enabled={{ .Values.s3.sslEnabled }}
    spark.hadoop.fs.s3a.aws.credentials.provider=org.apache.hadoop.fs.s3a.SimpleAWSCredentialsProvider

    # Event logging (History Server configured elsewhere)
    spark.eventLog.enabled=true
    spark.eventLog.dir=s3a://spark-standalone-logs/events
    spark.eventLog.compress=true

    # UI
    spark.ui.enabled=true

    # External Shuffle Service
    spark.shuffle.service.enabled={{ .Values.shuffleService.enabled }}
    spark.shuffle.service.port={{ .Values.shuffleService.port }}
    spark.dynamicAllocation.shuffleTracking.enabled=true

    {{- if .Values.hiveMetastore.enabled }}
    # Hive Metastore Configuration
    spark.sql.catalogImplementation=hive
    spark.hive.metastore.uris=thrift://{{ include "spark-standalone.fullname" . }}-metastore:{{ .Values.hiveMetastore.service.port }}
    spark.sql.warehouse.dir={{ .Values.hiveMetastore.warehouseDir }}
    spark.hadoop.hive.metastore.warehouse.dir={{ .Values.hiveMetastore.warehouseDir }}
    {{- end }}

  log4j2.properties: |
    rootLogger.level=INFO
    rootLogger.appenderRef.stdout.ref=console
    appender.console.type=Console
    appender.console.name=console
    appender.console.layout.type=PatternLayout
    appender.console.layout.pattern=%d{yy/MM/dd HH:mm:ss} %p %c{1}: %m%n
    logger.spark.name=org.apache.spark
    logger.spark.level=WARN
    logger.hadoop.name=org.apache.hadoop
    logger.hadoop.level=WARN
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: spark-env
  labels:
    {{- include "spark-standalone.labels" . | nindent 4 }}
data:
  S3_ENDPOINT: {{ .Values.s3.endpoint | quote }}
