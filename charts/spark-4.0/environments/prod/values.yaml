# Production Environment Values

connect:
  # Maximum replicas for HA
  replicas: 3

  # Maximum resources
  resources:
    requests:
      memory: "8Gi"
      cpu: "4"
    limits:
      memory: "16Gi"
      cpu: "8"

  # Dynamic allocation (production scale)
  dynamicAllocation:
    enabled: true
    initialExecutors: 3
    minExecutors: 2  # Keep minimum capacity
    maxExecutors: 50
    executorAllocationRatio: 0.5
    schedulerBacklogTimeout: "60s"

  # Pod Disruption Budget (HA)
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  # Production-hardened configuration
  sparkConf:
    # Production logging
    spark.sql.debug.maxToStringFields: "20"
    spark.driver.extraJavaOptions: >-
      -Dlog4j.configurationFile=file:///opt/spark/conf/log4j2-production.properties
    spark.executor.extraJavaOptions: >-
      -Dlog4j.configurationFile=file:///opt/spark/conf/log4j2-production.properties

    # Production timeouts
    spark.network.timeout: "800s"
    spark.executor.heartbeatInterval: "60s"
    spark.storage.blockManagerSlaveTimeout: "240s"

    # Production retry settings (AQE handles shuffle partitions)
    spark.task.maxFailures: "4"
    spark.speculation: "true"
    spark.speculation.multiplier: "2"

    # Serialization and compression
    spark.serializer: "org.apache.spark.serializer.KryoSerializer"
    spark.sql.parquet.compression.codec: "zstd"

    # Exclude on failure (Spark 4.x; was spark.blacklist in 3.x)
    spark.excludeOnFailure.enabled: "true"
    spark.excludeOnFailure.timeout: "30m"

# RBAC (minimal permissions)
rbac:
  create: true
  serviceAccountName: "spark-40"

# Maximum security
security:
  podSecurityStandards: true
  runAsUser: 185
  runAsGroup: 185
  fsGroup: 185
  readOnlyRootFilesystem: false  # Can be enabled for maximum security
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
    add:
      - NET_BIND_SERVICE
  networkPolicies:
    enabled: true

# Monitoring (always enabled in prod)
monitoring:
  serviceMonitor:
    enabled: true
    interval: "15s"
    scrapeTimeout: "10s"

# Secrets (external - REQUIRED)
secrets:
  externalSecrets:
    enabled: true  # REQUIRED in production
    region: "us-east-1"
    prefix: "prod"
  sealedSecrets:
    enabled: false
  vault:
    enabled: false

# VPA (disabled in production - use manual scaling)
vpa:
  enabled: false

# KEDA (disabled in production - use static scaling)
keda:
  enabled: false

# HPA (disabled in production - use static scaling)
hpa:
  enabled: false

# Cost exporter (disabled in production)
costExporter:
  enabled: false

# Production-specific settings
tolerations:
  - key: "workload"
    operator: "Equal"
    value: "production"
    effect: "NoSchedule"

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - spark-connect
        topologyKey: "kubernetes.io/hostname"
