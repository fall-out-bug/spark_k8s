{{- if .Values.core.hiveMetastore.enabled }}
{{- $chartName := .Chart.Name -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "spark.core.hiveMetastore.fullname" . }}-db
  labels:
    helm.sh/chart: {{ $chartName }}-{{ .Chart.Version }}
    app.kubernetes.io/component: "hive-metastore"
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/instance: {{ .Release.Name }}
type: Opaque
stringData:
  POSTGRES_USER: {{ .Values.core.hiveMetastore.postgresql.username | default "hive" | quote }}
  POSTGRES_PASSWORD: {{ .Values.core.hiveMetastore.postgresql.password | default "hive123" | quote }}
---
{{- if and .Values.core.hiveMetastore.enabled (not .Values.core.hiveMetastore.initSchema | default true) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "spark.core.hiveMetastore.fullname" . }}-init
  labels:
    helm.sh/chart: {{ $chartName }}-{{ .Chart.Version }}
    app.kubernetes.io/component: "hive-metastore"
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "2"
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $chartName }}-hive-metastore
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "spark.core.serviceAccountName" . }}
      {{- if .Values.security.podSecurityStandards }}
      securityContext:
        {{- include "spark.core.podSecurityContext" . | nindent 8 }}
      {{- end }}
      initContainers:
        {{- if .Values.core.postgresql.enabled }}
        - name: wait-for-postgresql
          image: busybox:1.36
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark.core.podSecurityContext" . | nindent 12 }}
            runAsUser: 1000
          {{- end }}
          command:
            - sh
            - -c
            - >
              echo "Waiting for network and DNS to initialize..."; sleep 20;
              until nc -z {{ include "spark.core.postgresql.fullname" . }} {{ .Values.core.postgresql.service.port }};
              do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"
        {{- end }}
      containers:
        - name: schematool
          image: "{{ .Values.core.hiveMetastore.image.repository }}:{{ .Values.core.hiveMetastore.image.tag }}"
          imagePullPolicy: {{ .Values.core.hiveMetastore.image.pullPolicy }}
          env:
            {{- if .Values.core.postgresql.enabled }}
            - name: POSTGRES_HOST
              value: {{ include "spark.core.postgresql.fullname" . | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.core.postgresql.service.port | quote }}
            {{- else }}
            - name: POSTGRES_HOST
              value: {{ .Values.core.hiveMetastore.postgresql.host | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.core.hiveMetastore.postgresql.port | quote }}
            {{- end }}
            - name: POSTGRES_DB
              value: {{ .Values.core.hiveMetastore.postgresql.database | default .Values.core.hiveMetastore.database.name | default "metastore" | quote }}
            - name: HIVE_CONF_DIR
              value: "/tmp/hive-conf"
          envFrom:
            - secretRef:
                name: {{ include "spark.core.hiveMetastore.fullname" . }}-db
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark.core.podSecurityContext" . | nindent 12 }}
            runAsUser: 1000
          {{- end }}
          command:
            - /bin/bash
            - -lc
            - |
              cat /opt/hive/conf/hive-site.xml.template | \
              sed "s/\${POSTGRES_HOST}/${POSTGRES_HOST}/g" | \
              sed "s/\${POSTGRES_PORT}/${POSTGRES_PORT}/g" | \
              sed "s/\${POSTGRES_DB}/${POSTGRES_DB}/g" | \
              sed "s/\${POSTGRES_USER}/${POSTGRES_USER}/g" | \
              sed "s#\${POSTGRES_PASSWORD}#${POSTGRES_PASSWORD}#g" \
              > /tmp/hive-conf/hive-site.xml
              /opt/hive/bin/schematool -dbType postgres -initOrUpgradeSchema
          volumeMounts:
            - name: hive-config
              mountPath: /opt/hive/conf/hive-site.xml.template
              subPath: hive-site.xml.template
            - name: tmp
              mountPath: /tmp
            - name: hive-conf
              mountPath: /tmp/hive-conf
      volumes:
        - name: hive-config
          configMap:
            name: {{ include "spark.core.hiveMetastore.fullname" . }}-config
        - name: tmp
          emptyDir: {}
        - name: hive-conf
          emptyDir: {}
{{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "spark.core.hiveMetastore.fullname" . }}
  labels:
    helm.sh/chart: {{ $chartName }}-{{ .Chart.Version }}
    app.kubernetes.io/component: "hive-metastore"
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ $chartName }}-hive-metastore
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $chartName }}-hive-metastore
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      serviceAccountName: {{ include "spark.core.serviceAccountName" . }}
      {{- if .Values.security.podSecurityStandards }}
      securityContext:
        {{- include "spark.core.podSecurityContext" . | nindent 8 }}
      {{- end }}
      initContainers:
        {{- if .Values.core.postgresql.enabled }}
        - name: wait-for-postgresql
          image: busybox:1.36
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark.core.podSecurityContext" . | nindent 12 }}
            runAsUser: 1000
            runAsGroup: 1000
          {{- end }}
          command:
            - sh
            - -c
            - >
              echo "Waiting for network and DNS to initialize..."; sleep 20;
              until nc -z {{ include "spark.core.postgresql.fullname" . }} {{ .Values.core.postgresql.service.port }};
              do echo "Waiting for PostgreSQL..."; sleep 2; done; echo "PostgreSQL is ready!"
        {{- end }}
      containers:
        - name: hive-metastore
          image: "{{ .Values.core.hiveMetastore.image.repository }}:{{ .Values.core.hiveMetastore.image.tag }}"
          imagePullPolicy: {{ .Values.core.hiveMetastore.image.pullPolicy }}
          env:
            - name: DB_DRIVER
              value: "postgres"
            - name: SERVICE_NAME
              value: "metastore"
            {{- if .Values.core.postgresql.enabled }}
            - name: POSTGRES_HOST
              value: {{ include "spark.core.postgresql.fullname" . | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.core.postgresql.service.port | quote }}
            {{- else }}
            - name: POSTGRES_HOST
              value: {{ .Values.core.hiveMetastore.postgresql.host | quote }}
            - name: POSTGRES_PORT
              value: {{ .Values.core.hiveMetastore.postgresql.port | quote }}
            {{- end }}
            - name: POSTGRES_DB
              value: {{ .Values.core.hiveMetastore.postgresql.database | default .Values.core.hiveMetastore.database.name | default "metastore" | quote }}
            - name: HIVE_CONF_DIR
              value: "/tmp/hive-conf"
          envFrom:
            - secretRef:
                name: {{ include "spark.core.hiveMetastore.fullname" . }}-db
          {{- if .Values.security.podSecurityStandards }}
          securityContext:
            {{- include "spark.core.podSecurityContext" . | nindent 12 }}
            runAsUser: 1000
          {{- end }}
          command:
            - /bin/bash
            - -lc
            - |
              cat /opt/hive/conf/hive-site.xml.template | \
              sed "s/\${POSTGRES_HOST}/${POSTGRES_HOST}/g" | \
              sed "s/\${POSTGRES_PORT}/${POSTGRES_PORT}/g" | \
              sed "s/\${POSTGRES_DB}/${POSTGRES_DB}/g" | \
              sed "s/\${POSTGRES_USER}/${POSTGRES_USER}/g" | \
              sed "s#\${POSTGRES_PASSWORD}#${POSTGRES_PASSWORD}#g" \
              > /tmp/hive-conf/hive-site.xml
              exec /opt/hive/bin/hive --service metastore
          ports:
            - name: thrift
              containerPort: {{ .Values.core.hiveMetastore.service.port }}
          resources:
            {{- toYaml .Values.core.hiveMetastore.resources | nindent 12 }}
          volumeMounts:
            - name: hive-config
              mountPath: /opt/hive/conf/hive-site.xml.template
              subPath: hive-site.xml.template
            - name: tmp
              mountPath: /tmp
            - name: hive-conf
              mountPath: /tmp/hive-conf
      volumes:
        - name: hive-config
          configMap:
            name: {{ include "spark.core.hiveMetastore.fullname" . }}-config
        - name: tmp
          emptyDir: {}
        - name: hive-conf
          emptyDir: {}
{{- end }}
