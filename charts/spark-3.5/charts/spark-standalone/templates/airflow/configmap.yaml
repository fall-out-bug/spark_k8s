{{- if .Values.airflow.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "spark-standalone.fullname" . }}-airflow-config
  labels:
    app: airflow
    {{- include "spark-standalone.labels" . | nindent 4 }}
data:
  AIRFLOW__CORE__EXECUTOR: "KubernetesExecutor"
  AIRFLOW__CORE__LOAD_EXAMPLES: "False"
  AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"
  AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "True"
  # Newer Airflow uses [kubernetes_executor]; keep legacy [kubernetes] too for compatibility.
  AIRFLOW__KUBERNETES_EXECUTOR__NAMESPACE: {{ default .Release.Namespace .Values.airflow.kubernetesExecutor.namespace | quote }}
  AIRFLOW__KUBERNETES__NAMESPACE: {{ default .Release.Namespace .Values.airflow.kubernetesExecutor.namespace | quote }}

  # KubernetesExecutor worker pods must run the Airflow image (not the Spark image).
  AIRFLOW__KUBERNETES_EXECUTOR__WORKER_CONTAINER_REPOSITORY: {{ default .Values.airflow.image.repository .Values.airflow.kubernetesExecutor.workerImage.repository | quote }}
  AIRFLOW__KUBERNETES_EXECUTOR__WORKER_CONTAINER_TAG: {{ default .Values.airflow.image.tag .Values.airflow.kubernetesExecutor.workerImage.tag | quote }}
  AIRFLOW__KUBERNETES__WORKER_CONTAINER_REPOSITORY: {{ default .Values.airflow.image.repository .Values.airflow.kubernetesExecutor.workerImage.repository | quote }}
  AIRFLOW__KUBERNETES__WORKER_CONTAINER_TAG: {{ default .Values.airflow.image.tag .Values.airflow.kubernetesExecutor.workerImage.tag | quote }}

  AIRFLOW__KUBERNETES_EXECUTOR__POD_TEMPLATE_FILE: "/opt/airflow/pod_templates/pod_template.yaml"
  # Keep worker pods only when debugging.
  AIRFLOW__KUBERNETES_EXECUTOR__DELETE_WORKER_PODS: {{ ternary "True" "False" (default true .Values.airflow.kubernetesExecutor.deleteWorkerPods) | quote }}
  AIRFLOW__KUBERNETES__DELETE_WORKER_PODS: {{ ternary "True" "False" (default true .Values.airflow.kubernetesExecutor.deleteWorkerPods) | quote }}
  AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: {{ printf "postgresql+psycopg2://%s:%s@%s:%d/%s" .Values.airflow.postgresql.username .Values.airflow.postgresql.password .Values.airflow.postgresql.host (int .Values.airflow.postgresql.port) .Values.airflow.postgresql.database | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "spark-standalone.fullname" . }}-airflow-dags
  labels:
    app: airflow
    {{- include "spark-standalone.labels" . | nindent 4 }}
data:
  example_bash_operator.py: |-
{{ .Files.Get "files/airflow/dags/example_bash_operator.py" | nindent 4 }}

  spark_etl_synthetic.py: |-
{{ .Files.Get "files/airflow/dags/spark_etl_synthetic.py" | nindent 4 }}

  mlflow_training_synthetic.py: |-
{{ .Files.Get "files/airflow/dags/mlflow_training_synthetic.py" | nindent 4 }}
{{- end }}
