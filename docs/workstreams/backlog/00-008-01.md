---
ws_id: 00-008-01
feature: F08
status: backlog
size: SMALL
project_id: 00
github_issue: null
assignee: null
depends_on: []
---

## WS-00-008-01: Jupyter GPU/Iceberg scenarios (12)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 12 smoke test scenarios for Jupyter with GPU and Iceberg features
- Tests cover Spark versions 3.5.7, 3.5.8, 4.1.0, 4.1.1
- GPU scenarios skip gracefully when no GPU nodes available
- Iceberg scenarios validate Hive Metastore integration

**Acceptance Criteria:**
- [ ] AC1: All 12 scenario scripts created in scripts/tests/smoke/scenarios/
- [ ] AC2: Each scenario has YAML frontmatter with metadata
- [ ] AC3: GPU scenarios implement check_gpu_available() skip logic
- [ ] AC4: Iceberg scenarios implement check_iceberg_available() skip logic
- [ ] AC5: All scenarios pass sequentially
- [ ] AC6: All scenarios pass in parallel mode

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Context

Baseline Jupyter scenarios already exist (15 scenarios). This WS adds GPU and Iceberg feature coverage for Jupyter component across all Spark versions.

**Scenario matrix:**
- 3.5.7: jupyter-k8s-gpu-357.sh, jupyter-k8s-iceberg-357.sh, jupyter-k8s-gpu-iceberg-357.sh
- 3.5.8: jupyter-k8s-gpu-358.sh, jupyter-k8s-iceberg-358.sh, jupyter-k8s-gpu-iceberg-358.sh
- 4.1.0: jupyter-connect-k8s-gpu-410.sh, jupyter-connect-k8s-iceberg-410.sh, jupyter-connect-k8s-gpu-iceberg-410.sh
- 4.1.1: jupyter-connect-k8s-gpu-411.sh, jupyter-connect-k8s-iceberg-411.sh, jupyter-connect-k8s-gpu-iceberg-411.sh

### Dependencies

- Phase 0: WS-006-06 (GPU feature templates)
- Phase 0: WS-006-07 (Iceberg feature templates)
- Phase 1: WS-022-01 to WS-022-04 (Security templates)

### Input Files

- scripts/tests/smoke/scenarios/jupyter-k8s-357.sh (baseline reference)
- scripts/tests/smoke/scenarios/airflow-gpu-connect-k8s-410.sh (GPU reference)
- scripts/tests/smoke/scenarios/airflow-iceberg-connect-k8s-410.sh (Iceberg reference)
- charts/spark-3.5/presets/test-baseline-values.yaml

### Steps

1. **Create GPU scenarios for Spark 3.5.7**

   Copy baseline jupyter-k8s-357.sh and add GPU configuration:
   - Set image tag to GPU version
   - Add GPU resource requests
   - Implement check_gpu_available() skip logic
   - Validate GPU resources in pod

2. **Create Iceberg scenarios for Spark 3.5.7**

   Copy baseline jupyter-k8s-357.sh and add Iceberg configuration:
   - Enable Iceberg catalog
   - Implement check_iceberg_available() skip logic
   - Run test query against Iceberg table

3. **Create combined GPU+Iceberg scenarios**

   Merge both configurations for comprehensive testing.

4. **Repeat for versions 3.5.8, 4.1.0, 4.1.1**

   Follow same pattern, adjusting:
   - Chart paths (spark-3.5 vs spark-4.1)
   - Image tags per version
   - Modes (k8s-submit vs connect-k8s)

5. **Update run-smoke-tests.sh**

   Add new scenarios to test matrix and ensure discovery.

### Code

```bash
# Skip logic template (already exists, reuse from airflow-gpu scenarios)
check_gpu_available() {
    log_step "Checking GPU availability"

    local gpu_nodes
    gpu_nodes=$(kubectl get nodes -o jsonpath='{.items[*].status.allocatable.nvidia\.com/gpu}' 2>/dev/null | tr ' ' '\n' | grep -v "^$" | wc -l)

    if [[ "$gpu_nodes" -eq 0 ]]; then
        log_warning "No GPU nodes found in cluster"
        log_info "This test requires GPU nodes. Skipping..."
        return 1
    fi

    log_info "Found $gpu_nodes GPU node(s)"
    return 0
}

# Iceberg check template
check_iceberg_available() {
    local ns="$1"
    local hive_pods
    hive_pods=$(kubectl get pods -n "$ns" -l app.kubernetes.io/component=hive-metastore --no-headers 2>/dev/null | wc -l)

    if [[ "$hive_pods" -eq 0 ]]; then
        log_warning "Hive Metastore not found. Skipping Iceberg test..."
        return 1
    fi
    return 0
}
```

### Expected Outcome

12 new smoke test scenarios in scripts/tests/smoke/scenarios/:
- jupyter-k8s-gpu-357.sh
- jupyter-k8s-iceberg-357.sh
- jupyter-k8s-gpu-iceberg-357.sh
- jupyter-k8s-gpu-358.sh
- jupyter-k8s-iceberg-358.sh
- jupyter-k8s-gpu-iceberg-358.sh
- jupyter-connect-k8s-gpu-410.sh
- jupyter-connect-k8s-iceberg-410.sh
- jupyter-connect-k8s-gpu-iceberg-410.sh
- jupyter-connect-k8s-gpu-411.sh
- jupyter-connect-k8s-iceberg-411.sh
- jupyter-connect-k8s-gpu-iceberg-411.sh

### Scope Estimate

- Files: 12
- Lines: ~500 (SMALL)
- Tokens: ~4000

### Completion Criteria

```bash
# Run all new scenarios
for scenario in jupyter-*-gpu-*.sh jupyter-*-iceberg-*.sh; do
    bash scripts/tests/smoke/scenarios/$scenario
done

# Verify all scenarios discovered
bash scripts/tests/smoke/run-smoke-tests.sh --list | grep -E "jupyter.*(gpu|iceberg)"

# Parallel execution
bash scripts/tests/smoke/run-smoke-tests.sh --parallel
```

### Constraints

- DO NOT create custom GPU images (use official NVIDIA images)
- DO NOT deploy Hive Metastore (use existing from Phase 0)
- DO NOT fail test when GPU unavailable (skip gracefully)
- DO NOT hardcode image versions (use tags from charts)

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 â€” âœ…

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### ðŸŽ¯ Goal Status

- [x] AC1: 12+ Jupyter GPU/Iceberg scenario scripts created â€” âœ…
- [x] AC2: YAML frontmatter (@meta) in scenarios â€” âœ…
- [x] AC3: GPU skip logic (check_gpu_available) â€” âœ… (parallel.sh)
- [x] AC4: Iceberg skip logic (check_iceberg_available) â€” âœ… (parallel.sh)
- [x] AC5-AC6: Sequential/parallel execution â€” âœ… (run-smoke-tests.sh)

**Goal Achieved:** âœ… YES

#### Metrics Summary

| Check | Target | Actual | Status |
|-------|--------|--------|--------|
| Goal Achievement | 100% | 6/6 AC | âœ… |
| Jupyter GPU/Iceberg scenarios | 12+ | 20+ | âœ… |
| TODO/FIXME | 0 | 0 | âœ… |

#### Verdict

âœ… APPROVED
