---
ws_id: 00-006-03
feature: F06
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on: ["00-006-01"]
---

## WS-006-03: PostgreSQL Core Template

### üéØ Goal

**What must WORK after completing this WS:**
- PostgreSQL deployment template in core/ directory
- Service and PVC templates
- Database initialization support
- Hive Metastore database setup

**Acceptance Criteria:**
- [ ] AC1: `templates/core/_postgresql-deployment.yaml` created
- [ ] AC2: `templates/core/_postgresql-service.yaml` created
- [ ] AC3: `templates/core/_postgresql-pvc.yaml` created
- [ ] AC4: Values structure supports database configuration
- [ ] AC5: `helm template --validate` passes

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Context

PostgreSQL is used for:
- Hive Metastore database
- Airflow database (optional)
- MLflow database (optional)

### Dependencies

WS-006-01 (Core template structure)

### Input Files

- `charts/spark-base/templates/postgresql.yaml`
- `charts/spark-base/values.yaml` (postgresql section)

### Steps

1. **Create PostgreSQL deployment template**
   - Migrate from `spark-base/templates/postgresql.yaml`
   - Use core component labels
   - Add conditional rendering

2. **Create service and PVC templates**
   - Service on port 5432
   - PVC for data persistence

3. **Add database initialization**
   - Support creating databases on startup
   - Hive metastore database by default

### Code

```yaml
# templates/core/_postgresql-deployment.yaml
{{- if .Values.core.postgresql.enabled -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "spark.fullname" . }}-postgresql
  labels:
    {{- include "spark.core.labels" (dict "Component" "postgresql" | merge .) | nindent 4 }}
spec:
  # ... (migrate from spark-base)
{{- end }}
```

```yaml
# values.yaml
core:
  postgresql:
    enabled: true
    auth:
      username: hive
      password: hive123
    databases:
      - metastore
```

### Expected Outcome

- PostgreSQL templates in core/ directory
- Backward compatible with spark-base
- Databases created on deployment

### Scope Estimate

- Files: ~4 templates + values
- Lines: ~300 (MEDIUM)
- Tokens: ~4500

### Completion Criteria

```bash
helm template test charts/spark-4.1 \
  --set core.postgresql.enabled=true \
  --validate
```

### Constraints

- DO NOT break existing spark-base postgresql
- DO NOT change default credentials

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC5 ‚Äî ‚úÖ

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______

### Deviations from Plan
- ______

### Commit
______
