---
ws_id: 00-014-07
feature: F14
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Helm charts
  - 00-007-01  # Security templates
---

## WS-00-014-07: S3 security (6 scenarios)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 6 S3 security test scenarios
- TLS in-flight validation
- Server-side encryption validation
- IRSA annotation for EKS

**Acceptance Criteria:**
- [ ] AC1: 6 S3 security test scenarios created
- [ ] AC2: TLS endpoint validated (HTTPS only)
- [ ] AC3: Server-side encryption configured
- [ ] AC4: IRSA annotation validated for EKS
- [ ] AC5: No HTTP endpoints
- [ ] AC6: Encryption algorithm specified

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Scenarios

| Scenario | Check | Target | Expected |
|----------|-------|--------|----------|
| 1 | TLS endpoint | s3:// URL | Uses https:// |
| 2 | TLS endpoint | s3a:// URL | Uses https:// |
| 3 | Encryption at rest | fs.s3a.server-side-encryption-algorithm | AES256 or aws:kms |
| 4 | KMS key | fs.s3a.server-side-encryption-key | ARN specified |
| 5 | IRSA annotation | service-account annotation | eks.amazonaws.com/role-arn |
| 6 | No HTTP | endpoint URL | Not http:// |

### Dependencies

- WS-006-01 (Helm charts)
- WS-007-01 (Security templates)

### Code

```python
# tests/security/s3/test_s3_tls_endpoint.py
import pytest
import yaml

def test_s3_tls_endpoint(helm_chart_path):
    """
    Validate S3 endpoint uses TLS (HTTPS)
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "minio.enabled=true",
        "--set", "minio.tls.enabled=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))

    # Check ConfigMaps for S3 configuration
    configmaps = [doc for doc in docs if doc.get("kind") == "ConfigMap"]

    for cm in configmaps:
        data = cm.get("data", {})

        for key, value in data.items():
            # Check for S3 endpoint URLs
            if "s3" in value.lower() and "endpoint" in key.lower():
                # Must use HTTPS
                assert "https://" in value or value.startswith("s3://") or value.startswith("s3a://"), \
                    f"S3 endpoint must use HTTPS or s3:// protocol: {value}"

                # Must not use HTTP
                assert "http://" not in value, \
                    f"S3 endpoint must not use plain HTTP: {value}"

def test_s3_encryption_at_rest(helm_chart_path):
    """
    Validate S3 server-side encryption is configured
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "sparkConf.fs.s3a.server-side-encryption-algorithm=AES256"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))

    # Check ConfigMaps/Env vars for encryption config
    configmaps = [doc for doc in docs if doc.get("kind") == "ConfigMap"]
    deployments = [doc for doc in docs if doc.get("kind") == "Deployment"]

    encryption_found = False
    encryption_algorithm = None

    # Check ConfigMaps
    for cm in configmaps:
        data = cm.get("data", {})

        # Check for encryption algorithm
        if "fs.s3a.server-side-encryption-algorithm" in data:
            encryption_algorithm = data["fs.s3a.server-side-encryption-algorithm"]
            encryption_found = True

        # Also check in spark-defaults.conf style content
        for value in data.values():
            if "fs.s3a.server-side-encryption-algorithm" in value:
                # Parse value from config file content
                for line in value.split("\n"):
                    if "fs.s3a.server-side-encryption-algorithm" in line:
                        parts = line.split("=")
                        if len(parts) >= 2:
                            encryption_algorithm = parts[1].strip()
                            encryption_found = True

    # Check Deployments (env vars)
    for deploy in deployments:
        pod_spec = deploy.get("spec", {}).get("template", {}).get("spec", {})
        for container in pod_spec.get("containers", []):
            env_list = container.get("env", [])
            for env in env_list:
                if env.get("name") == "SPARK_CONF_FS_S3A_SERVER_SIDE_ENCRYPTION_ALGORITHM":
                    encryption_algorithm = env.get("value")
                    encryption_found = True

    assert encryption_found, "S3 encryption algorithm not configured"

    # Validate encryption algorithm
    assert encryption_algorithm in ["AES256", "aws:kms"], \
        f"Encryption algorithm must be AES256 or aws:kms, got {encryption_algorithm}"

def test_s3_kms_key(helm_chart_path):
    """
    Validate S3 KMS key is specified when using aws:kms
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "sparkConf.fs.s3a.server-side-encryption-algorithm=aws:kms",
        "--set", "sparkConf.fs.s3a.server-side-encryption-key=arn:aws:kms:..."
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))

    configmaps = [doc for doc in docs if doc.get("kind") == "ConfigMap"]

    kms_key_found = False
    kms_key_arn = None

    for cm in configmaps:
        data = cm.get("data", {})

        if "fs.s3a.server-side-encryption-key" in data:
            kms_key_arn = data["fs.s3a.server-side-encryption-key"]
            kms_key_found = True

        for value in data.values():
            if "fs.s3a.server-side-encryption-key" in value:
                for line in value.split("\n"):
                    if "fs.s3a.server-side-encryption-key" in line:
                        parts = line.split("=")
                        if len(parts) >= 2:
                            kms_key_arn = parts[1].strip()
                            kms_key_found = True

    if kms_key_found:
        # Validate KMS key ARN format
        assert kms_key_arn.startswith("arn:aws:kms:"), \
            f"KMS key must be valid ARN, got {kms_key_arn}"

def test_s3_irsa_annotation(helm_chart_path):
    """
    Validate IRSA (IAM Roles for Service Accounts) annotation for EKS
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "serviceAccount.annotations.eks\\.amazonaws\\.com/role-arn=arn:aws:iam::123456:role/s3-access"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))

    # Check ServiceAccounts for IRSA annotation
    service_accounts = [doc for doc in docs if doc.get("kind") == "ServiceAccount"]

    irsa_found = False
    for sa in service_accounts:
        annotations = sa.get("metadata", {}).get("annotations", {})

        # Check for IRSA annotation
        irsa_arn = annotations.get("eks.amazonaws.com/role-arn")

        if irsa_arn:
            irsa_found = True

            # Validate ARN format
            assert irsa_arn.startswith("arn:aws:iam::"), \
                f"IRSA role ARN must be valid IAM ARN, got {irsa_arn}"

            # Should be a role, not user
            assert ":role/" in irsa_arn, \
                f"IRSA must reference IAM role, not user: {irsa_arn}"

    assert irsa_found, "IRSA annotation not found on ServiceAccount"

def test_s3_no_http_endpoints(helm_chart_path):
    """
    Validate no plain HTTP endpoints for S3
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "minio.enabled=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    manifest = result.stdout

    # Check for http:// URLs (excluding https://)
    import re

    # Find all URLs
    url_pattern = r'http[s]?://[^\s<>"{}|\\^`\[\]]+'
    urls = re.findall(url_pattern, manifest)

    for url in urls:
        # If URL contains s3/minio/s3a, must be HTTPS
        if any(keyword in url.lower() for keyword in ["s3", "minio", "s3a"]):
            assert url.startswith("https://") or url.startswith("s3://") or url.startswith("s3a://"), \
                f"S3/MinIO endpoint must use HTTPS: {url}"

def test_s3_connection_security(helm_chart_path):
    """
    Validate overall S3 connection security
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "minio.enabled=true",
        "--set", "minio.tls.enabled=true",
        "--set", "sparkConf.fs.s3a.connection.ssl.enabled=true",
        "--set", "sparkConf.fs.s3a.server-side-encryption-algorithm=AES256"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))

    # Validate SSL is enabled for S3A
    ssl_enabled = False

    configmaps = [doc for doc in docs if doc.get("kind") == "ConfigMap"]
    for cm in configmaps:
        data = cm.get("data", {})

        for key, value in data.items():
            # Check for SSL enabled
            if "fs.s3a.connection.ssl.enabled" in key or "fs.s3a.connection.ssl.enabled" in value:
                if "true" in value.lower() or value == "true":
                    ssl_enabled = True

    assert ssl_enabled, "S3A SSL connection must be enabled"
```

### Scope Estimate

- Files: 6
- Lines: ~500 (MEDIUM)
- Tokens: ~4000

### Constraints

- DO enforce TLS for S3 endpoints
- DO configure server-side encryption
- DO validate IRSA annotations for EKS
- DO NOT allow plain HTTP endpoints
- DO validate KMS key ARN format

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 â€” âœ…

**Goal Achieved:** ______
