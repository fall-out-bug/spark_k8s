---
ws_id: 00-016-01
feature: F16
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Helm charts
---

## WS-00-016-01: Metrics collection (Prometheus)

### üéØ Goal

**What must WORK after completing this WS:**
- Prometheus Helm chart –¥–ª—è Spark K8s
- JMX exporter –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Spark
- K8s metrics —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
- Scrape –Ω–∞—Å—Ç—Ä–æ–µ–Ω (15s –∏–Ω—Ç–µ—Ä–≤–∞–ª)

**Acceptance Criteria:**
- [ ] AC1: Prometheus Helm chart —Å–æ–∑–¥–∞–Ω
- [ ] AC2: JMX exporter pod sidecar –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] AC3: Spark metrics –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Prometheus
- [ ] AC4: K8s metrics (kube-state-metrics) —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] AC5: Scrape –∏–Ω—Ç–µ—Ä–≤–∞–ª 15s
- [ ] AC6: Data retention 15d

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Dependencies

Phase 0 (F06)

### Code

```yaml
# charts/observability/prometheus/values.yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

prometheus:
  prometheusSpec:
    retention: 15d
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 1000m
        memory: 4Gi
    serviceMonitorSelectorNilUsesHelmValues: false

# JMX exporter configuration
sparkMetrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 15s
    scrapeTimeout: 10s

  jmxExporter:
    enabled: true
    image:
      repository: bitnami/jmx-exporter
      tag: latest
    port: 9404
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # Spark JMX configuration
    config:
      rules:
      - pattern: 'metrics<type=ExecutorMetrics>(\w+)'
        name: spark_executor_$1
        type: GAUGE
      - pattern: 'metrics<type=DriverMetrics>(\w+)'
        name: spark_driver_$1
        type: GAUGE
      - pattern: 'metrics<type=ShuffleMetrics>(\w+)'
        name: spark_shuffle_$1
        type: COUNTER

# K8s metrics
kubeStateMetrics:
  enabled: true

nodeExporter:
  enabled: true
```

```yaml
# charts/observability/prometheus/templates/servicemonitor.yaml
{{- if .Values.sparkMetrics.serviceMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "spark-k8s.fullname" . }}-metrics
  labels:
    app: {{ include "spark-k8s.name" . }}
    component: metrics
    release: {{ .Release.Name }}
spec:
  selector:
    matchLabels:
      app: {{ include "spark-k8s.name" . }}
      component: spark
  namespaceSelector:
    matchNames:
      - {{ .Release.Namespace }}
  endpoints:
  - port: jmx-metrics
    interval: {{ .Values.sparkMetrics.serviceMonitor.interval }}
    scrapeTimeout: {{ .Values.sparkMetrics.serviceMonitor.scrapeTimeout }}
    path: /metrics
{{- end }}
```

### Scope Estimate

- Files: 8
- Lines: ~700 (MEDIUM)
- Tokens: ~5500

### Constraints

- DO use Prometheus for metrics storage
- DO use JMX exporter for Spark metrics
- DO scrape every 15s
- DO NOT exceed 5GB storage (2 week retention)

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 ‚Äî ‚úÖ

**Goal Achieved:** ______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### üéØ Goal Status

- [x] AC1: Prometheus chart ‚Äî ‚úÖ Exists
- [ ] AC2: JMX exporter pod sidecar ‚Äî ‚ö†Ô∏è ServiceMonitor only
- [ ] AC3‚ÄìAC6: Scrape 15s, retention 15d ‚Äî ‚ö†Ô∏è Values use 30s; helm dependency missing

**Goal Achieved:** ‚ö†Ô∏è Partial

#### Issues

| # | Severity | Issue | Fix | Status |
|---|----------|-------|-----|--------|
| 1 | ~~HIGH~~ | ~~helm dependency build not run~~ | helm dependency build | ‚úÖ FIXED (emp) |
| 2 | ~~HIGH~~ | ~~servicemonitor template spark scope~~ | Use observability values | ‚úÖ FIXED (kcj) |
| 3 | MEDIUM | prometheus values.yaml YAML error | serviceMonitors structure | ‚úÖ FIXED (review 2026-02-10) |
