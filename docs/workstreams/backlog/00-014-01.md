---
ws_id: 00-014-01
feature: F14
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Helm charts
  - 00-007-01  # Security templates
---

## WS-00-014-01: PSS tests (8 scenarios)

### üéØ Goal

**What must WORK after completing this WS:**
- 8 PSS (Pod Security Standards) test scenarios
- Validation via helm template + kubeconform
- restricted/baseline profiles for Spark 3.5/4.1

**Acceptance Criteria:**
- [ ] AC1: 8 PSS test scenarios created
- [ ] AC2: PSS restricted profile validated (kubeconform)
- [ ] AC3: PSS baseline profile validated
- [ ] AC4: Spark 3.5 compatibility confirmed
- [ ] AC5: Spark 4.1 compatibility confirmed
- [ ] AC6: All presets pass PSS validation

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Scenarios

| Scenario | Profile | Spark Version | Preset | Check |
|----------|---------|---------------|--------|-------|
| 1 | restricted | 3.5.7 | baseline-jupyter | kubeconform pass |
| 2 | restricted | 3.5.8 | baseline-airflow | kubeconform pass |
| 3 | restricted | 4.1.0 | gpu-jupyter | kubeconform pass |
| 4 | restricted | 4.1.1 | gpu-airflow | kubeconform pass |
| 5 | baseline | 3.5.7 | baseline-jupyter | kubeconform pass |
| 6 | baseline | 3.5.8 | baseline-airflow | kubeconform pass |
| 7 | baseline | 4.1.0 | iceberg-jupyter | kubeconform pass |
| 8 | baseline | 4.1.1 | iceberg-airflow | kubeconform pass |

### Dependencies

- WS-006-01 (Helm charts)
- WS-007-01 (Security templates)

### Code

```python
# tests/security/pss/test_pss_restricted_35.py
import pytest
import subprocess
import yaml

def test_pss_restricted_spark_357_jupyter(helm_chart_path):
    """
    Validate PSS restricted compliance for Spark 3.5.7 Jupyter preset
    Using helm template + kubeconform
    """
    # Generate manifests
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "preset.jupyter.enabled=true",
        "--set", "podSecurityContext.enabled=true",
        "--set", "containerSecurityContext.runAsNonRoot=true",
        "--set", "containerSecurityContext.allowPrivilegeEscalation=false",
        "--set", "containerSecurityContext.capabilities.drop[]=ALL",
        "--set", "containerSecurityContext.readOnlyRootFilesystem=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0, f"helm template failed: {result.stderr}"

    # Validate with kubeconform
    validate_cmd = [
        "kubeconform",
        "-strict",
        "-kubernetes-version", "1.26.0",
        "-schema-location", "https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{.ResourceKind}}.json",
        "-"
    ]

    validate_result = subprocess.run(
        validate_cmd,
        input=result.stdout,
        capture_output=True,
        text=True
    )

    assert validate_result.returncode == 0, f"kubeconform failed: {validate_result.stderr}"

    # Parse YAML and check PSS fields
    docs = list(yaml.safe_load_all(result.stdout))
    pods = [doc for doc in docs if doc.get("kind") == "Pod"]

    for pod in pods:
        # Check securityContext at pod level
        assert pod.get("spec", {}).get("securityContext") is not None, "Missing pod securityContext"
        sc = pod["spec"]["securityContext"]

        # PSS restricted requirements
        assert sc.get("runAsNonRoot") == True, "runAsNonRoot must be true"
        assert sc.get("seccompProfile", {}).get("type") in ["RuntimeDefault", "Localhost"], "Invalid seccompProfile"

        # Check containers
        for container in pod.get("spec", {}).get("containers", []):
            csc = container.get("securityContext", {})

            assert csc.get("allowPrivilegeEscalation") == False, "allowPrivilegeEscalation must be false"
            assert csc.get("capabilities", {}).get("drop") is not None, "Must drop capabilities"
            assert "ALL" in csc.get("capabilities", {}).get("drop", []), "Must drop ALL capabilities"
```

### Scope Estimate

- Files: 8
- Lines: ~600 (MEDIUM)
- Tokens: ~4500

### Constraints

- DO use kubeconform for PSS validation
- DO test both restricted and baseline profiles
- DO NOT use real k8s cluster (dry-run only)
- DO validate all preset combinations

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 ‚Äî ‚úÖ

**Goal Achieved:** ______
