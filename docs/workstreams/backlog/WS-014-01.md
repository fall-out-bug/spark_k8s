---
ws_id: WS-014-01
feature: F14
status: backlog
size: MEDIUM
project_id: 014
github_issue: null
assignee: null
depends_on: []
---

## WS-014-01: PSS tests (8 scenarios)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 8 PSS (Pod Security Standards) test scenarios validating restricted/baseline profiles
- Tests cover Spark 3.5 and 4.1 charts with different presets
- kubeconform validation for PSS compliance

**Acceptance Criteria:**
- [ ] AC1: 4 test files created in tests/security/pss/
- [ ] AC2: test_pss_restricted_35.py validates PSS restricted for Spark 3.5
- [ ] AC3: test_pss_restricted_41.py validates PSS restricted for Spark 4.1
- [ ] AC4: test_pss_baseline_35.py validates PSS baseline for Spark 3.5
- [ ] AC5: test_pss_baseline_41.py validates PSS baseline for Spark 4.1
- [ ] AC6: All tests use helm template + yaml parsing for validation
- [ ] AC7: Coverage >= 80% for all PSS test files
- [ ] AC8: All tests pass with pytest

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Context

PSS (Pod Security Standards) are Kubernetes-native security controls that replace PodSecurityPolicy. This WS creates tests to validate that our Helm charts comply with PSS restricted and baseline profiles.

**Test Matrix (8 scenarios):**
- Spark 3.5 + PSS restricted Ã— presets (core-baseline, core-gpu, core-iceberg)
- Spark 4.1 + PSS restricted Ã— presets (core-baseline, core-gpu, core-iceberg)
- Spark 3.5 + PSS baseline Ã— standalone preset
- Spark 4.1 + PSS baseline Ã— standalone preset

### Dependencies

- Phase 0: Core chart templates with security context
- Phase 1: PSS labels in namespace.yaml

### Input Files

- charts/spark-3.5/templates/namespace.yaml (PSS labels)
- charts/spark-4.1/templates/namespace.yaml (PSS labels)
- charts/spark-3.5/presets/core-baseline.yaml
- charts/spark-4.1/presets/core-baseline.yaml

### Steps

1. **Create tests/security/pss/test_pss_restricted_35.py**

   Write tests for Spark 3.5 PSS restricted compliance:
   - Test namespace has PSS restricted labels
   - Test non-root user (runAsUser != 0)
   - Test privilege escalation disabled
   - Test capabilities dropped
   - Test seccomp profile set

2. **Create tests/security/pss/test_pss_restricted_41.py**

   Write tests for Spark 4.1 PSS restricted compliance (same pattern as 3.5)

3. **Create tests/security/pss/test_pss_baseline_35.py**

   Write tests for Spark 3.5 PSS baseline compliance:
   - Test namespace has PSS baseline labels
   - Test basic security context

4. **Create tests/security/pss/test_pss_baseline_41.py**

   Write tests for Spark 4.1 PSS baseline compliance (same pattern as 3.5)

5. **Add pytest conftest fixtures**

   Create shared fixtures in tests/security/conftest.py:
   - helm_template fixture for running helm template
   - yaml_docs fixture for parsing YAML output

### Code

```python
# tests/security/pss/test_pss_restricted_35.py
"""PSS Restricted tests for Spark 3.5"""

import pytest
import subprocess
import yaml
from pathlib import Path


class TestPSSRestricted35:
    """Tests for PSS restricted profile compliance on Spark 3.5"""

    @pytest.fixture(scope="class")
    def chart_path(self):
        return Path(__file__).parent.parent.parent.parent / "charts" / "spark-3.5"

    @pytest.fixture(scope="class")
    def preset_path(self, chart_path):
        return chart_path / "presets" / "core-baseline.yaml"

    def test_namespace_pss_restricted_labels(self, chart_path, preset_path):
        """Test that namespace has PSS restricted labels"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--show-only", "templates/namespace.yaml"],
            capture_output=True, text=True
        )
        assert result.returncode == 0, "helm template should succeed"

        docs = list(yaml.safe_load_all(result.stdout))
        namespace = next((d for d in docs if d and d.get("kind") == "Namespace"), None)
        assert namespace is not None, "Namespace should be rendered"

        labels = namespace.get("metadata", {}).get("labels", {})
        assert labels.get("pod-security.kubernetes.io/enforce") == "restricted", \
            "Should enforce PSS restricted"
        assert labels.get("pod-security.kubernetes.io/audit") == "restricted", \
            "Should audit PSS restricted"
        assert labels.get("pod-security.kubernetes.io/warn") == "restricted", \
            "Should warn PSS restricted"

    def test_non_root_user(self, chart_path, preset_path):
        """Test that containers run as non-root user"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path)],
            capture_output=True, text=True
        )
        assert result.returncode == 0

        docs = list(yaml.safe_load_all(result.stdout))
        for doc in docs:
            if doc and doc.get("kind") in ["Deployment", "StatefulSet", "Pod"]:
                template = doc.get("spec", {}).get("template", {})
                containers = template.get("spec", {}).get("containers", [])
                for container in containers:
                    # Check security context
                    sec_ctx = container.get("securityContext", {})
                    run_as_user = sec_ctx.get("runAsUser")
                    if run_as_user is not None:
                        assert run_as_user != 0, f"Container {container['name']} should not run as root"
```

### Expected Outcome

4 new test files in tests/security/pss/:
- test_pss_restricted_35.py (~150 LOC)
- test_pss_restricted_41.py (~150 LOC)
- test_pss_baseline_35.py (~100 LOC)
- test_pss_baseline_41.py (~100 LOC)
- tests/security/conftest.py (shared fixtures, ~100 LOC)

### Scope Estimate

- Files: 5
- Lines: ~600 (MEDIUM)
- Tokens: ~5000

### Completion Criteria

```bash
# Run all PSS tests
pytest tests/security/pss/ -v

# Coverage check
pytest tests/security/pss/ --cov=tests/security/pss --cov-report=term-missing --cov-fail-under=80

# Specific test
pytest tests/security/pss/test_pss_restricted_35.py::TestPSSRestricted35::test_namespace_pss_restricted_labels -v
```

### Constraints

- DO NOT require actual Kubernetes cluster (use helm template only)
- DO NOT create real resources (dry-run validation only)
- DO NOT assume kubeconform is installed (skip gracefully if missing)
- MUST validate both Spark 3.5 and 4.1 charts

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC8 â€” âœ…

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### ðŸŽ¯ Goal Status

- [x] AC1: 4 test files in tests/security/pss/ â€” âœ…
- [x] AC2: test_pss_restricted_35.py validates PSS restricted for Spark 3.5 â€” âœ…
- [x] AC3: test_pss_restricted_41.py validates PSS restricted for Spark 4.1 â€” âœ…
- [x] AC4: test_pss_baseline_35.py validates PSS baseline for Spark 3.5 â€” âœ…
- [x] AC5: test_pss_baseline_41.py validates PSS baseline for Spark 4.1 â€” âœ…
- [x] AC6: All tests use helm template + yaml parsing â€” âœ…
- [x] AC7: Coverage >= 80% (88%) â€” âœ…
- [x] AC8: All tests pass â€” âœ…

**Goal Achieved:** âœ… YES

#### Metrics Summary

| Check | Status |
|-------|--------|
| Completion Criteria | âœ… |
| Tests & Coverage | âœ… 88% |
| AI-Readiness | âœ… max 169 LOC |
| Type Hints | âœ… |
| Error Handling | âœ… |
