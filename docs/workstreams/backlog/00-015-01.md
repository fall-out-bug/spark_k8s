---
ws_id: 00-015-01
feature: F15
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Helm charts
  - 00-008-02  # Smoke tests
  - 00-012-01  # E2E tests
  - 00-013-01  # Load tests
---

## WS-00-015-01: Parallel execution framework

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- Parallel execution framework Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
- Namespace/release isolation
- Configurable concurrency
- Automatic cleanup

**Acceptance Criteria:**
- [ ] AC1: Parallel execution script ÑÐ¾Ð·Ð´Ð°Ð½
- [ ] AC2: 4+ concurrent tests Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚
- [ ] AC3: Namespace isolation Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] AC4: Configurable concurrency (MAX_PARALLEL)
- [ ] AC5: Automatic cleanup Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] AC6: Retry mechanism Ð´Ð»Ñ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Dependencies

Phase 0 (F06), Phase 2 (F08), Phase 6 (F12), Phase 7 (F13)

### Code

```bash
#!/bin/bash
# scripts/parallel/run_parallel.sh

set -euo pipefail

# Configuration
MAX_PARALLEL=${MAX_PARALLEL:-4}
SCENARIOS_DIR=${SCENARIOS_DIR:-scripts/tests/smoke/scenarios}
RESULTS_DIR=${RESULTS_DIR:-test-results}
TIMESTAMP=$(date +%s)

# Create results directory
mkdir -p "${RESULTS_DIR}"

# Cleanup handler
cleanup() {
    local exit_code=$?
    echo "Cleaning up namespaces..."
    ./scripts/parallel/cleanup.sh
    exit ${exit_code}
}
trap cleanup EXIT INT TERM

# Get list of scenarios
scenarios=($(find "${SCENARIOS_DIR}" -name "*.sh" -type f | sort))

echo "Found ${#scenarios[@]} scenarios"
echo "Running with MAX_PARALLEL=${MAX_PARALLEL}"

# Export functions for parallel
export -f run_scenario
export RESULTS_DIR TIMESTAMP

# Run scenarios in parallel using GNU parallel
if command -v parallel &> /dev/null; then
    echo "Using GNU parallel..."
    printf "%s\n" "${scenarios[@]}" | parallel -j "${MAX_PARALLEL}" --timeout 3600 \
        ./scripts/parallel/run_scenario.sh {} "${RESULTS_DIR}" "${TIMESTAMP}"
else
    echo "GNU parallel not found, using xargs..."
    printf "%s\n" "${scenarios[@]}" | xargs -P "${MAX_PARALLEL}" -I {} \
        ./scripts/parallel/run_scenario.sh {} "${RESULTS_DIR}" "${TIMESTAMP}"
fi

echo "All scenarios completed"
```

```bash
#!/bin/bash
# scripts/parallel/run_scenario.sh

set -euo pipefail

SCENARIO_SCRIPT=$1
RESULTS_DIR=$2
TIMESTAMP=$3

SCENARIO_NAME=$(basename "${SCENARIO_SCRIPT}" .sh)
NAMESPACE="spark-test-${SCENARIO_NAME}-${TIMESTAMP}-${RANDOM}"
RELEASE_NAME="spark-${SCENARIO_NAME}-${RANDOM}"
RESULT_FILE="${RESULTS_DIR}/${SCENARIO_NAME}.json"

echo "Running scenario: ${SCENARIO_NAME}"
echo "Namespace: ${NAMESPACE}"
echo "Release: ${RELEASE_NAME}"

# Create unique namespace
kubectl create namespace "${NAMESPACE}" || {
    echo "Failed to create namespace ${NAMESPACE}"
    echo '{"status": "failed", "reason": "namespace_creation_failed"}' > "${RESULT_FILE}"
    exit 1
}

# Run scenario
exit_code=0
if "${SCENARIO_SCRIPT}" "${NAMESPACE}" "${RELEASE_NAME}"; then
    echo '{"status": "passed", "exit_code": 0}' > "${RESULT_FILE}"
else
    exit_code=$?
    echo "{\"status\": \"failed\", \"exit_code\": ${exit_code}}" > "${RESULT_FILE}"
fi

# Cleanup namespace (deferred to main cleanup)
echo "${NAMESPACE}" >> "${RESULTS_DIR}/namespaces.txt"

exit ${exit_code}
```

```bash
#!/bin/bash
# scripts/parallel/cleanup.sh

set -euo pipefail

RESULTS_DIR=${RESULTS_DIR:-test-results}

if [ -f "${RESULTS_DIR}/namespaces.txt" ]; then
    echo "Cleaning up namespaces..."

    while IFS= read -r namespace; do
        echo "Deleting namespace: ${namespace}"
        kubectl delete namespace "${namespace}" --ignore-not-found=true --wait=true || true
    done < "${RESULTS_DIR}/namespaces.txt"

    rm -f "${RESULTS_DIR}/namespaces.txt"
fi

echo "Cleanup complete"
```

### Scope Estimate

- Files: 6
- Lines: ~800 (MEDIUM)
- Tokens: ~6000

### Constraints

- DO use GNU parallel if available, fallback to xargs
- DO create unique namespaces per test
- DO automatic cleanup on exit
- DO NOT leave orphaned namespaces

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 â€” âœ…

**Goal Achieved:** ______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### ðŸŽ¯ Goal Status

- [x] AC1: Parallel execution script ÑÐ¾Ð·Ð´Ð°Ð½ â€” âœ… run_parallel.sh
- [x] AC2: 4+ concurrent tests â€” âœ… MAX_PARALLEL, GNU parallel/xargs
- [x] AC3: Namespace isolation â€” âœ…
- [x] AC4: Configurable concurrency â€” âœ…
- [x] AC5: Automatic cleanup â€” âœ…
- [x] AC6: Retry mechanism Ð´Ð»Ñ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð² â€” âœ… MAX_RETRIES=3 (bead 78m CLOSED)

**Goal Achieved:** âœ…

#### Metrics Summary

| Check | Status |
|-------|--------|
| Completion Criteria | âœ… |
| File Size | âœ… max 151 LOC |
| Error Handling | âœ… |

#### Issues

| # | Severity | Issue | Fix |
|---|----------|-------|-----|
| 1 | ~~MEDIUM~~ | ~~No retry on namespace creation failure~~ | âœ… FIXED (bead 78m CLOSED) |
