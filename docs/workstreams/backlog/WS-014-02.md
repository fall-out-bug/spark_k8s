---
ws_id: WS-014-02
feature: F14
status: backlog
size: MEDIUM
project_id: 014
github_issue: null
assignee: null
depends_on: []
---

## WS-014-02: SCC tests (12 scenarios)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 12 SCC (Security Context Constraints) test scenarios for OpenShift compatibility
- Tests cover anyuid, nonroot, restricted-v2 SCCs
- Mocked `oc` command validation (no real OpenShift cluster required)

**Acceptance Criteria:**
- [ ] AC1: 4 test files created in tests/security/scc/
- [ ] AC2: test_scc_anyuid.py validates anyuid SCC compatibility
- [ ] AC3: test_scc_nonroot.py validates nonroot SCC compatibility
- [ ] AC4: test_scc_restricted_v2.py validates restricted-v2 SCC compatibility
- [ ] AC5: test_scc_presets.py validates OpenShift preset configurations
- [ ] AC6: All tests use mocked `oc` commands
- [ ] AC7: Coverage >= 80% for all SCC test files
- [ ] AC8: All tests pass with pytest

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Context

OpenShift uses Security Context Constraints (SCCs) instead of raw PSS. SCCs are similar to PSS but with OpenShift-specific features like anyuid for legacy workloads. This WS creates tests to validate that our Helm charts are compatible with OpenShift SCCs.

**Test Matrix (12 scenarios):**
- anyuid SCC Ã— Spark 3.5/4.1 Ã— components (connect, history-server)
- nonroot SCC Ã— Spark 3.5/4.1 Ã— components (jupyter, hive-metastore)
- restricted-v2 SCC Ã— Spark 3.5/4.1 Ã— components
- OpenShift presets Ã— anyuid/restricted compatibility

### Dependencies

- Phase 0: OpenShift preset configurations
- Phase 1: SCC-compatible security contexts

### Input Files

- charts/spark-3.5/presets/openshift/anyuid.yaml
- charts/spark-3.5/presets/openshift/restricted.yaml
- charts/spark-4.1/presets/openshift/anyuid.yaml
- charts/spark-4.1/presets/openshift/restricted.yaml

### Steps

1. **Create tests/security/scc/test_scc_anyuid.py**

   Write tests for anyuid SCC compatibility:
   - Test that anyuid preset disables PSS (anyuid bypasses PSS)
   - Test OpenShift UID range (1000000000+)
   - Test that containers can run with any UID
   - Test that fsGroup is set correctly

2. **Create tests/security/scc/test_scc_nonroot.py**

   Write tests for nonroot SCC compatibility:
   - Test that non-root user is required
   - Test that privilege escalation is disabled
   - Test that read-only root filesystem can be enabled

3. **Create tests/security/scc/test_scc_restricted_v2.py**

   Write tests for restricted-v2 SCC compatibility:
   - Test that restricted SCC is most secure
   - Test that containers run as specific UID (185 or 1000000000)
   - Test that drop capabilities are set

4. **Create tests/security/scc/test_scc_presets.py**

   Write tests for OpenShift preset configurations:
   - Test that anyuid preset is valid for anyuid SCC
   - Test that restricted preset is valid for restricted-v2 SCC
   - Test that preset values match SCC requirements

5. **Mock oc command fixture**

   Create fixture in tests/security/conftest.py:
   - mock_oc_adm_policy_scc_review fixture
   - Mock YAML output for SCC review

### Code

```python
# tests/security/scc/test_scc_anyuid.py
"""SCC anyuid tests for OpenShift compatibility"""

import pytest
import subprocess
import yaml
from pathlib import Path
from unittest.mock import patch, MagicMock


class TestSCCAnyuid:
    """Tests for anyuid SCC compatibility"""

    @pytest.fixture(scope="class")
    def chart_path(self):
        return Path(__file__).parent.parent.parent.parent / "charts" / "spark-3.5"

    @pytest.fixture(scope="class")
    def preset_path(self, chart_path):
        return chart_path / "presets" / "openshift" / "anyuid.yaml"

    def test_anyuid_disables_pss(self, chart_path, preset_path):
        """Test that anyuid preset disables PSS (anyuid bypasses PSS)"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--show-only", "templates/namespace.yaml"],
            capture_output=True, text=True
        )
        assert result.returncode == 0

        # PSS should be disabled when using anyuid SCC
        docs = list(yaml.safe_load_all(result.stdout))
        namespace = next((d for d in docs if d and d.get("kind") == "Namespace"), None)
        if namespace:
            # anyuid preset should NOT set PSS labels (they bypass PSS)
            labels = namespace.get("metadata", {}).get("labels", {})
            assert "pod-security.kubernetes.io/enforce" not in labels or \
                   labels.get("pod-security.kubernetes.io/enforce") == "privileged", \
                "anyuid SCC should bypass PSS restrictions"

    def test_openshift_uid_range(self, chart_path, preset_path):
        """Test that anyuid preset uses OpenShift UID range"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path)],
            capture_output=True, text=True
        )
        assert result.returncode == 0

        docs = list(yaml.safe_load_all(result.stdout))
        for doc in docs:
            if doc and doc.get("kind") in ["Deployment", "StatefulSet"]:
                sec_ctx = doc.get("spec", {}).get("template", {}).get("spec", {}).get("securityContext", {})
                run_as_user = sec_ctx.get("runAsUser")
                # OpenShift UID range starts at 1000000000
                if run_as_user is not None:
                    assert run_as_user >= 1000000000, \
                        f"Should use OpenShift UID range, got {run_as_user}"

    @patch('subprocess.run')
    def test_scc_review_mock(self, mock_run, chart_path, preset_path):
        """Test SCC review with mocked oc command"""
        # Mock oc adm policy scc-review output
        mock_result = MagicMock()
        mock_result.returncode = 0
        mock_result.stdout = """
allowedBy: anyuid
securityContext:
  runAsUser: 1000000000
  fsGroup: 1000000000
"""
        mock_run.return_value = mock_result

        # Simulate SCC review
        result = subprocess.run(
            ["oc", "adm", "policy", "scc-review", "-z", "spark-35-openshift"],
            capture_output=True, text=True
        )

        assert "allowedBy: anyuid" in result.stdout
```

### Expected Outcome

4 new test files in tests/security/scc/:
- test_scc_anyuid.py (~200 LOC)
- test_scc_nonroot.py (~200 LOC)
- test_scc_restricted_v2.py (~250 LOC)
- test_scc_presets.py (~250 LOC)
- tests/security/conftest.py (mock fixtures, ~100 LOC)

### Scope Estimate

- Files: 5
- Lines: ~1000 (MEDIUM)
- Tokens: ~8000

### Completion Criteria

```bash
# Run all SCC tests
pytest tests/security/scc/ -v

# Coverage check
pytest tests/security/scc/ --cov=tests/security/scc --cov-report=term-missing --cov-fail-under=80

# Specific test
pytest tests/security/scc/test_scc_anyuid.py::TestSCCAnyuid::test_anyuid_disables_pss -v
```

### Constraints

- DO NOT require actual OpenShift cluster (use mocked `oc` command)
- DO NOT create real SCC resources (validation only)
- DO NOT fail if `oc` command is not available (skip gracefully)
- MUST validate both Spark 3.5 and 4.1 charts

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC8 â€” âœ…

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______
