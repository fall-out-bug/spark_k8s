---
ws_id: WS-014-03
feature: F14
status: backlog
size: MEDIUM
project_id: 014
github_issue: null
assignee: null
depends_on: []
---

## WS-014-03: Network policies (6 scenarios)

### üéØ Goal

**What must WORK after completing this WS:**
- 6 network policy test scenarios validating default-deny + explicit allow
- Tests cover Spark component communication rules
- Tests validate MinIO/PostgreSQL access rules

**Acceptance Criteria:**
- [ ] AC1: 3 test files created in tests/security/network/
- [ ] AC2: test_network_default_deny.py validates default-deny ingress/egress
- [ ] AC3: test_network_explicit_allow.py validates explicit allow rules
- [ ] AC4: test_network_component_rules.py validates component-specific rules
- [ ] AC5: All tests use helm template + yaml parsing
- [ ] AC6: Coverage >= 80% for all network policy test files
- [ ] AC7: All tests pass with pytest

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Context

Network policies control pod-to-pod communication in Kubernetes. A secure default is default-deny (block all traffic) with explicit allow rules for required communication. This WS creates tests to validate that our Helm charts implement network policies correctly.

**Test Matrix (6 scenarios):**
- Default-deny ingress (block all incoming traffic)
- Default-deny egress (block all outgoing traffic)
- Explicit allow: Spark Connect server access
- Explicit allow: DNS egress (required for service discovery)
- Explicit allow: S3 egress (MinIO or external S3)
- Explicit allow: PostgreSQL egress (for Hive Metastore)

### Dependencies

- Phase 0: Network policy templates
- Phase 1: Network policy configuration in values

### Input Files

- charts/spark-3.5/templates/networking/network-policy.yaml (if exists)
- charts/spark-4.1/templates/networking/network-policy.yaml (if exists)
- charts/spark-3.5/values.yaml (network policy configuration)

### Steps

1. **Create tests/security/network/test_network_default_deny.py**

   Write tests for default-deny network policies:
   - Test that default-deny policy exists
   - Test that default-deny blocks both ingress and egress
   - Test that default-deny has no specific selectors (applies to all pods)

2. **Create tests/security/network/test_network_explicit_allow.py**

   Write tests for explicit allow rules:
   - Test that DNS egress is allowed (port 53 TCP/UDP)
   - Test that S3 egress is allowed (port 9000 or 443)
   - Test that PostgreSQL egress is allowed (port 5432)
   - Test that Kubernetes API server egress is allowed

3. **Create tests/security/network/test_network_component_rules.py**

   Write tests for component-specific rules:
   - Test that Spark Connect server ingress is allowed
   - Test that Jupyter ingress is allowed
   - Test that History Server ingress is allowed
   - Test that pod selectors match actual component labels

### Code

```python
# tests/security/network/test_network_default_deny.py
"""Network policy tests for default-deny rules"""

import pytest
import subprocess
import yaml
from pathlib import Path


class TestNetworkDefaultDeny:
    """Tests for default-deny network policies"""

    @pytest.fixture(scope="class")
    def chart_path(self):
        return Path(__file__).parent.parent.parent.parent / "charts" / "spark-3.5"

    @pytest.fixture(scope="class")
    def preset_path(self, chart_path):
        return chart_path / "presets" / "core-baseline.yaml"

    def test_default_deny_ingress_exists(self, chart_path, preset_path):
        """Test that default-deny ingress policy is defined"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--show-only", "templates/networking/network-policy.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("Network policy template not found")

        docs = list(yaml.safe_load_all(result.stdout))
        default_deny = None

        for doc in docs:
            if doc and doc.get("kind") == "NetworkPolicy":
                metadata = doc.get("metadata", {})
                if "default-deny" in metadata.get("name", "").lower():
                    default_deny = doc
                    break

        # If no network policy exists, that's OK for now
        if default_deny is None:
            pytest.skip("Default-deny network policy not implemented yet")

        # Validate default-deny configuration
        spec = default_deny.get("spec", {})
        policy_types = spec.get("policyTypes", [])

        assert "Ingress" in policy_types, "Default-deny should block ingress"
        assert "Egress" in policy_types, "Default-deny should block egress"

        # Default-deny should have no rules (empty rules list)
        rules = spec.get("rules", [])
        # Empty rules means deny all
        assert len(rules) == 0 or all(
            r.get("policyTypes") == ["Egress"] for r in rules
        ), "Default-deny ingress should have no allow rules"

    def test_default_deny_applies_to_all_pods(self, chart_path, preset_path):
        """Test that default-deny applies to all pods in namespace"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--show-only", "templates/networking/network-policy.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("Network policy template not found")

        docs = list(yaml.safe_load_all(result.stdout))

        for doc in docs:
            if doc and doc.get("kind") == "NetworkPolicy":
                metadata = doc.get("metadata", {})
                if "default-deny" in metadata.get("name", "").lower():
                    spec = doc.get("spec", {})
                    pod_selector = spec.get("podSelector", {})

                    # Empty podSelector means applies to all pods
                    assert pod_selector == {} or pod_selector.get("matchLabels") is None, \
                        "Default-deny should apply to all pods (empty selector)"
```

### Expected Outcome

3 new test files in tests/security/network/:
- test_network_default_deny.py (~150 LOC)
- test_network_explicit_allow.py (~200 LOC)
- test_network_component_rules.py (~150 LOC)

### Scope Estimate

- Files: 3
- Lines: ~500 (MEDIUM)
- Tokens: ~4000

### Completion Criteria

```bash
# Run all network policy tests
pytest tests/security/network/ -v

# Coverage check
pytest tests/security/network/ --cov=tests/security/network --cov-report=term-missing --cov-fail-under=80

# Specific test
pytest tests/security/network/test_network_default_deny.py::TestNetworkDefaultDeny::test_default_deny_ingress_exists -v
```

### Constraints

- DO NOT require actual Kubernetes cluster (use helm template only)
- DO NOT fail if network policy template doesn't exist (skip gracefully)
- DO NOT assume CNI plugin (test validates YAML, not actual enforcement)
- MUST validate policy selectors match actual pod labels

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC7 ‚Äî ‚úÖ

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______
