---
ws_id: 00-017-02
feature: F17
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-017-01  # Go client library
---

## WS-00-017-02: Go smoke tests

### üéØ Goal

**What must WORK after completing this WS:**
- 12 smoke test —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è Go –∫–ª–∏–µ–Ω—Ç–∞
- Connection validation
- Basic SQL operations
- DataFrame operations
- Connection lifecycle

**Acceptance Criteria:**
- [ ] AC1: 12 smoke test —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å–æ–∑–¥–∞–Ω—ã
- [ ] AC2: Connection tests —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] AC3: SQL operation tests —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] AC4: DataFrame operation tests —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] AC5: Error handling tests —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] AC6: –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Dependencies

WS-017-01 (Go client library)

### Scenarios

| Scenario | Spark Version | Mode | Test Type |
|----------|---------------|------|-----------|
| 1 | 3.5.7 | connect-k8s | Connection |
| 2 | 3.5.8 | connect-k8s | Connection |
| 3 | 4.1.0 | connect-k8s | Connection |
| 4 | 4.1.1 | connect-k8s | Connection |
| 5 | 3.5.7 | connect-k8s | SQL operations |
| 6 | 3.5.8 | connect-k8s | SQL operations |
| 7 | 4.1.0 | connect-k8s | SQL operations |
| 8 | 4.1.1 | connect-k8s | SQL operations |
| 9 | 3.5.7 | connect-k8s | DataFrame |
| 10 | 3.5.8 | connect-k8s | DataFrame |
| 11 | 4.1.0 | connect-k8s | DataFrame |
| 12 | 4.1.1 | connect-k8s | DataFrame |

### Code

```go
// tests/go/smoke/connect_test.go
package smoke

import (
	"context"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	spark "github.com/org/spark-k8s/tests/go/client"
)

func TestGoClientConnection_357(t *testing.T) {
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Minute)
	defer cancel()

	// Connect to Spark 3.5.7 Connect server
	client, err := spark.NewClient(ctx, "spark-3-5-7-connect:15002")
	require.NoError(t, err, "Failed to connect to Spark Connect")
	defer client.Close()

	// Create session
	session, err := client.CreateSession(ctx)
	require.NoError(t, err, "Failed to create session")
	defer session.Close(ctx)

	// Verify session ID
	assert.NotEmpty(t, session.ID(), "Session ID should not be empty")
}

func TestGoClientConnection_411(t *testing.T) {
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Minute)
	defer cancel()

	// Connect to Spark 4.1.1 Connect server
	client, err := spark.NewClient(ctx, "spark-4-1-1-connect:15002")
	require.NoError(t, err, "Failed to connect to Spark Connect")
	defer client.Close()

	// Create session
	session, err := client.CreateSession(ctx)
	require.NoError(t, err, "Failed to create session")
	defer session.Close(ctx)

	// Verify session ID
	assert.NotEmpty(t, session.ID(), "Session ID should not be empty")
}

func TestGoClientBasicSQL_358(t *testing.T) {
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Minute)
	defer cancel()

	client, err := spark.NewClient(ctx, "spark-3-5-8-connect:15002")
	require.NoError(t, err)
	defer client.Close()

	session, err := client.CreateSession(ctx)
	require.NoError(t, err)
	defer session.Close(ctx)

	// Execute simple SQL query
	df, err := session.SQL(ctx, "SELECT 1 AS one, 2 AS two")
	require.NoError(t, err)

	// Collect results
	rows, err := df.Collect(ctx)
	require.NoError(t, err)

	// Verify results
	assert.Len(t, rows, 1, "Should have exactly 1 row")

	one, err := rows[0].GetInt(0)
	require.NoError(t, err)
	assert.Equal(t, int32(1), one)

	two, err := rows[0].GetInt(1)
	require.NoError(t, err)
	assert.Equal(t, int32(2), two)
}

func TestGoClientAggregation_410(t *testing.T) {
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Minute)
	defer cancel()

	client, err := spark.NewClient(ctx, "spark-4-1-0-connect:15002")
	require.NoError(t, err)
	defer client.Close()

	session, err := client.CreateSession(ctx)
	require.NoError(t, err)
	defer session.Close(ctx)

	// Create test data
	_, err = session.SQL(ctx, `
		CREATE OR REPLACE TEMPORARY VIEW test_data AS
		SELECT * FROM VALUES
			(1, 'Alice', 100),
			(2, 'Bob', 200),
			(3, 'Charlie', 150)
		AS test_data(id, name, value)
	`)
	require.NoError(t, err)

	// Execute aggregation
	df, err := session.SQL(ctx, `
		SELECT
			SUM(value) as total_value,
			AVG(value) as avg_value,
			COUNT(*) as count
		FROM test_data
	`)
	require.NoError(t, err)

	rows, err := df.Collect(ctx)
	require.NoError(t, err)
	assert.Len(t, rows, 1)

	// Verify aggregation
	total, err := rows[0].GetInt(0)
	require.NoError(t, err)
	assert.Equal(t, int32(450), total) // 100 + 200 + 150
}

func TestGoClientErrorHandling(t *testing.T) {
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Minute)
	defer cancel()

	client, err := spark.NewClient(ctx, "spark-connect-test:15002")
	require.NoError(t, err)
	defer client.Close()

	session, err := client.CreateSession(ctx)
	require.NoError(t, err)
	defer session.Close(ctx)

	// Execute invalid SQL
	_, err = session.SQL(ctx, "SELECT * FROM non_existent_table")
	assert.Error(t, err, "Should return error for invalid table")
}

func TestGoClientDataFrameOperations(t *testing.T) {
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Minute)
	defer cancel()

	client, err := spark.NewClient(ctx, "spark-connect-test:15002")
	require.NoError(t, err)
	defer client.Close()

	session, err := client.CreateSession(ctx)
	require.NoError(t, err)
	defer session.Close(ctx)

	// Create test data
	_, err = session.SQL(ctx, `
		CREATE OR REPLACE TEMPORARY VIEW df_test AS
		SELECT * FROM VALUES
			(1, 100),
			(2, 200),
			(3, 300)
		AS df_test(id, value)
	`)
	require.NoError(t, err)

	// Test Count
	df, err := session.SQL(ctx, "SELECT * FROM df_test")
	require.NoError(t, err)

	count, err := df.Count(ctx)
	require.NoError(t, err)
	assert.Equal(t, int64(3), count)

	// Test Show
	err = df.Show(ctx)
	require.NoError(t, err)
}

func TestGoClientConnectionLifecycle(t *testing.T) {
	ctx, cancel := context.WithTimeout(context.Background(), 2*time.Minute)
	defer cancel()

	// Test multiple sessions
	client, err := spark.NewClient(ctx, "spark-connect-test:15002")
	require.NoError(t, err)
	defer client.Close()

	// Create first session
	session1, err := client.CreateSession(ctx)
	require.NoError(t, err)
	assert.NotEmpty(t, session1.ID())

	// Create second session
	session2, err := client.CreateSession(ctx)
	require.NoError(t, err)
	assert.NotEmpty(t, session2.ID())

	// Sessions should have different IDs
	assert.NotEqual(t, session1.ID(), session2.ID())

	// Close first session
	err = session1.Close(ctx)
	require.NoError(t, err)

	// Second session should still work
	df, err := session2.SQL(ctx, "SELECT 1")
	require.NoError(t, err)
	rows, err := df.Collect(ctx)
	require.NoError(t, err)
	assert.Len(t, rows, 1)
}
```

### Scope Estimate

- Files: 6
- Lines: ~600 (MEDIUM)
- Tokens: ~4500

### Constraints

- DO use Go test framework
- DO use testify for assertions
- DO table-driven tests for versions
- DO test connection lifecycle
- DO NOT require external dependencies

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 ‚Äî ‚úÖ

**Goal Achieved:** ______
