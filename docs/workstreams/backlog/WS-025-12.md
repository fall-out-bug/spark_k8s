---
ws_id: 025-12
feature: F25
status: backlog
size: LARGE
project_id: 00
github_issue: null
assignee: null
depends_on: ["025-03", "025-04"]
---

## WS-025-12: Spark Job Tracing + Profiling Dashboards and Recipes

### ğŸ¯ Goal

**What must WORK after completing this WS:**
- OpenTelemetry tracing Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² Spark Connect ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
- 2 Ğ½Ğ¾Ğ²Ñ‹Ñ… Grafana Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°: tracing timeline + profiling bottlenecks
- 5 Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¾Ğ² Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
- Event log profiling Ñ‡ĞµÑ€ĞµĞ· History Server Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¸ Ğ·Ğ°Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½

**Acceptance Criteria:**
- [ ] AC1: spark-connect-configmap.yaml Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ OTel tracing config (conditional)
- [ ] AC2: values.yaml ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ `monitoring.openTelemetry` ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (endpoint, protocol, sampling)
- [ ] AC3: Grafana Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´ "Spark Job Tracing" ÑĞ¾Ğ·Ğ´Ğ°Ğ½ (job/stage/task timeline, DAG bottlenecks)
- [ ] AC4: Grafana Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´ "Spark Profiling" ÑĞ¾Ğ·Ğ´Ğ°Ğ½ (GC time, ser/deser, shuffle skew, spill, idle)
- [ ] AC5: Ğ ĞµÑ†ĞµĞ¿Ñ‚ `docs/recipes/troubleshoot/slow-spark-jobs.md` ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [ ] AC6: Ğ ĞµÑ†ĞµĞ¿Ñ‚ `docs/recipes/troubleshoot/data-skew-diagnosis.md` ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [ ] AC7: Ğ ĞµÑ†ĞµĞ¿Ñ‚ `docs/recipes/troubleshoot/oom-and-spill.md` ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [ ] AC8: Ğ ĞµÑ†ĞµĞ¿Ñ‚ `docs/recipes/troubleshoot/shuffle-bottleneck.md` ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [ ] AC9: Ğ ĞµÑ†ĞµĞ¿Ñ‚ `docs/recipes/troubleshoot/gc-pressure.md` ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [ ] AC10: `docs/recipes/observability/spark-profiling-guide.md` ÑĞ¾Ğ·Ğ´Ğ°Ğ½ (Ğ¾Ğ±Ğ·Ğ¾Ñ€Ğ½Ñ‹Ğ¹ guide)
- [ ] AC11: helm template Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½Ğ½Ñ‹Ğ¼ OTel tracing
- [ ] AC12: ĞĞ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ `docs/recipes/observability/observability-stack.md` (ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ñ‹)

**WS is NOT complete until Goal is achieved (all AC checked).**

### Grafana Dashboard: Spark Job Tracing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spark Job Tracing                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  [Job Timeline]          [Stage Breakdown]             â”‚
â”‚  â”Œâ”€Job 1â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€Stage 0â”€â”€â”                  â”‚
â”‚  â”‚ Stage0 â”‚ Stage1 â”‚     â”‚ 200 tasksâ”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ p95: 2.1sâ”‚                  â”‚
â”‚  â”Œâ”€Job 2â”€â”€â”€â”€â”            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚  â”‚ Stage2   â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            [Task Distribution]           â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  [Bottleneck Detection]  â”‚ â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘ â”‚            â”‚
â”‚  â€¢ Shuffle wait: 45%     â”‚ min/median/max â”‚            â”‚
â”‚  â€¢ GC time: 12%          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â€¢ Skew ratio: 3.2x                                   â”‚
â”‚                          [Trace Spans]                 â”‚
â”‚                          job â†’ stage â†’ task â†’ shuffle  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Grafana Dashboard: Spark Profiling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spark Profiling                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  [GC Time %]             [Serialization Time]          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ â–“â–“â–“â–‘â–‘â–‘â–‘â–‘ â”‚ 15%        â”‚ â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚ 3%              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                        â”‚
â”‚  [Shuffle Skew]          [Spill to Disk]               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ max/avg  â”‚ 4.1x       â”‚ 2.3 GB   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                        â”‚
â”‚  [Executor Utilization]  [Peak Memory per Executor]    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚ 38%    â”‚ â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘ â”‚ 78%          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                        â”‚
â”‚  [Task Duration Heatmap]                               â”‚
â”‚  Executor0 â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘                                 â”‚
â”‚  Executor1 â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“                          â”‚
â”‚  Executor2 â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Recipes Overview

| Recipe | Problem | Key Metrics | Action |
|--------|---------|-------------|--------|
| slow-spark-jobs | Job takes too long | task duration p95, stage time | identify bottleneck stage |
| data-skew-diagnosis | Uneven data distribution | max/median task size ratio | repartition, salting |
| oom-and-spill | Executor OOM, spill | memory used, spill bytes | tune memory, partitions |
| shuffle-bottleneck | Slow shuffle | shuffle read/write time, bytes | optimize partitioning |
| gc-pressure | High GC pause | GC time %, full GC count | tune JVM, reduce objects |

### OpenTelemetry Configuration

```yaml
# values.yaml addition
monitoring:
  openTelemetry:
    enabled: false
    endpoint: "http://otel-collector:4317"
    protocol: "grpc"           # grpc or http
    samplingRatio: "1.0"       # 0.0-1.0
    serviceName: "spark-connect-35"
    exporterType: "otlp"       # otlp or jaeger
```

Spark 3.5 config properties:
```
spark.plugins=org.apache.spark.sql.connect.SparkConnectPlugin
spark.opentelemetry.enabled=true
spark.otel.exporter.otlp.endpoint=...
spark.otel.resource.attributes=service.name=spark-connect-35
```

### Files Changed

- `charts/spark-3.5/templates/spark-connect-configmap.yaml` (ADD OTel config)
- `charts/spark-3.5/values.yaml` (ADD monitoring.openTelemetry)
- `charts/spark-3.5/templates/monitoring/grafana-dashboard-job-tracing.yaml` (NEW)
- `charts/spark-3.5/templates/monitoring/grafana-dashboard-profiling.yaml` (NEW)
- `docs/recipes/troubleshoot/slow-spark-jobs.md` (NEW)
- `docs/recipes/troubleshoot/data-skew-diagnosis.md` (NEW)
- `docs/recipes/troubleshoot/oom-and-spill.md` (NEW)
- `docs/recipes/troubleshoot/shuffle-bottleneck.md` (NEW)
- `docs/recipes/troubleshoot/gc-pressure.md` (NEW)
- `docs/recipes/observability/spark-profiling-guide.md` (NEW)
- `docs/recipes/observability/observability-stack.md` (UPDATE)
