---
ws_id: 00-014-02
feature: F14
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Helm charts
  - 00-007-01  # Security templates
---

## WS-00-014-02: SCC tests (12 scenarios)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 12 SCC (Security Context Constraints) test scenarios
- OpenShift compatibility validation (mocked `oc` commands)
- anyuid, nonroot, restricted-v2 presets

**Acceptance Criteria:**
- [ ] AC1: 12 SCC test scenarios created
- [ ] AC2: anyuid SCC compatibility validated
- [ ] AC3: nonroot SCC compatibility validated
- [ ] AC4: restricted-v2 SCC compatibility validated
- [ ] AC5: Mock `oc` commands work correctly
- [ ] AC6: All Spark versions compatible with SCC

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Scenarios

| Scenario | SCC Type | Spark Version | Component | Check |
|----------|----------|---------------|-----------|-------|
| 1 | anyuid | 3.5.7 | Jupyter | YAML compatible |
| 2 | anyuid | 3.5.8 | Airflow | YAML compatible |
| 3 | anyuid | 4.1.0 | Spark Connect | YAML compatible |
| 4 | anyuid | 4.1.1 | Spark Connect | YAML compatible |
| 5 | nonroot | 3.5.7 | Jupyter | YAML compatible |
| 6 | nonroot | 3.5.8 | Airflow | YAML compatible |
| 7 | nonroot | 4.1.0 | Spark Connect | YAML compatible |
| 8 | nonroot | 4.1.1 | Spark Connect | YAML compatible |
| 9 | restricted-v2 | 3.5.7 | History Server | YAML compatible |
| 10 | restricted-v2 | 3.5.8 | History Server | YAML compatible |
| 11 | restricted-v2 | 4.1.0 | Hive Metastore | YAML compatible |
| 12 | restricted-v2 | 4.1.1 | Hive Metastore | YAML compatible |

### Dependencies

- WS-006-01 (Helm charts)
- WS-007-01 (Security templates)

### Code

```python
# tests/security/scc/test_scc_anyuid.py
import pytest
from unittest.mock import patch, MagicMock
import subprocess

@pytest.fixture
def mock_oc_client():
    """Mock OpenShift client"""
    with patch('openshift.dynamic.Client') as mock_client:
        client = MagicMock()
        mock_client.return_value = client
        yield client

def test_scc_anyuid_spark_357_jupyter(helm_chart_path, mock_oc_client):
    """
    Validate SCC anyuid compatibility for Spark 3.5.7 Jupyter
    Using mocked oc commands (no real OpenShift cluster needed)
    """
    # Generate manifests
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "preset.jupyter.enabled=true",
        "--set", "openshift.enabled=true",
        "--set", "openshift.scc.enabled=true",
        "--set", "openshift.scc.type=anyuid"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0, f"helm template failed: {result.stderr}"

    # Parse YAML for SCC annotations
    import yaml
    docs = list(yaml.safe_load_all(result.stdout))

    # Check for SCC annotations on ServiceAccount
    service_accounts = [doc for doc in docs if doc.get("kind") == "ServiceAccount"]

    for sa in service_accounts:
        annotations = sa.get("metadata", {}).get("annotations", {})

        # anyuid SCC requires this annotation
        assert "openshift.io/sa.scc.uid-range" in annotations or \
               "openshift.io/scc.anyuid" in annotations, \
               f"Missing SCC annotations for ServiceAccount {sa['metadata']['name']}"

    # Mock oc get scc validation
    mock_oc_client.resources.get.return_value.get.return_value = MagicMock(
        metadata=MagicMock(name="anyuid"),
        allowPrivilegedContainer=True,
        runAsUser=MagicMock(type="RunAsAny"),
        seLinuxContext=MagicMock(type="MustRunAs"),
        fsGroup=MagicMock(type="RunAsAny"),
        supplementalGroups=MagicMock(type="RunAsAny")
    )

    # Verify SCC exists (mocked)
    scc = mock_oc_client.resources.get.return_value.get(name="anyuid")
    assert scc is not None, "anyuid SCC not found"
    assert scc.allowPrivilegedContainer == True, "anyuid should allow privileged containers"

def test_scc_nonroot_spark_358_airflow(helm_chart_path, mock_oc_client):
    """
    Validate SCC nonroot compatibility for Spark 3.5.8 Airflow
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "preset.airflow.enabled=true",
        "--set", "openshift.enabled=true",
        "--set", "openshift.scc.enabled=true",
        "--set", "openshift.scc.type=nonroot"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    # Check for non-root user
    import yaml
    docs = list(yaml.safe_load_all(result.stdout))
    deployments = [doc for doc in docs if doc.get("kind") == "Deployment"]

    for deploy in deployments:
        uid = deploy.get("spec", {}).get("template", {}).get(
            "spec", {}).get("securityContext", {}).get("runAsUser"
        )
        assert uid is not None and uid > 0, f"Deployment must run as non-root user, got uid: {uid}"

def test_scc_restricted_v2_spark_410_history(helm_chart_path):
    """
    Validate SCC restricted-v2 compatibility for Spark 4.1.0 History Server
    """
    cmd = [
        "helm", "template", "spark-4.1",
        helm_chart_path,
        "--set", "historyServer.enabled=true",
        "--set", "openshift.enabled=true",
        "--set", "openshift.scc.enabled=true",
        "--set", "openshift.scc.type=restricted-v2"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    # restricted-v2 requires strict security
    import yaml
    docs = list(yaml.safe_load_all(result.stdout))

    for doc in docs:
        if doc.get("kind") in ["Deployment", "StatefulSet", "DaemonSet"]:
            pod_spec = doc.get("spec", {}).get("template", {}).get("spec", {})

            # Check non-root
            uid = pod_spec.get("securityContext", {}).get("runAsUser")
            assert uid is not None and uid > 0, "restricted-v2 requires non-root"

            # Check no privilege escalation
            for container in pod_spec.get("containers", []):
                csc = container.get("securityContext", {})
                assert csc.get("allowPrivilegeEscalation") == False, \
                    "restricted-v2 forbids privilege escalation"
```

### Scope Estimate

- Files: 12
- Lines: ~900 (MEDIUM)
- Tokens: ~7000

### Constraints

- DO mock `oc` commands (no real OpenShift cluster)
- DO test all SCC types: anyuid, nonroot, restricted-v2
- DO validate YAML compatibility
- DO NOT require OpenShift environment

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 â€” âœ…

**Goal Achieved:** ______
