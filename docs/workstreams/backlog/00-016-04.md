---
ws_id: 00-016-04
feature: F16
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-016-01  # Metrics collection
  - 00-016-02  # Logging aggregation
---

## WS-00-016-04: Dashboards (Grafana)

### üéØ Goal

**What must WORK after completing this WS:**
- Grafana Helm chart –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- 5+ –¥–∞—à–±–æ—Ä–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ
- Prometheus datasource –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Loki datasource –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Jaeger datasource –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**Acceptance Criteria:**
- [ ] AC1: Grafana Helm chart —Å–æ–∑–¥–∞–Ω
- [ ] AC2: Prometheus datasource —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] AC3: Loki datasource —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] AC4: Jaeger datasource —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] AC5: 5+ dashboards —Å–æ–∑–¥–∞–Ω—ã
- [ ] AC6: Dashboards auto-provision

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Dependencies

WS-016-01, WS-016-02

### Dashboards List

1. **Cluster Overview**: Overall cluster health, nodes, pods
2. **Spark Applications**: App status, stages, tasks
3. **Executor Metrics**: Memory, CPU, GC, shuffle
4. **SQL Performance**: Query execution, planning, metrics
5. **Resource Usage**: CPU, memory, storage by namespace/pod

### Code

```yaml
# charts/observability/grafana/values.yaml
grafana:
  enabled: true
  adminPassword: admin

  persistence:
    enabled: true
    size: 10Gi

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus:9090
        access: proxy
        isDefault: true
        editable: true

      - name: Loki
        type: loki
        url: http://loki:3100
        access: proxy
        editable: true

      - name: Jaeger
        type: jaeger
        url: http://jaeger-query:16686
        access: proxy
        editable: true

  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: spark-k8s
        orgId: 1
        folder: Spark K8s
        type: file
        disableDeletion: false
        options:
          path: /var/lib/grafana/dashboards/spark-k8s

  dashboards:
    spark-k8s:
      cluster-overview:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Spark K8s
        url: https://raw.githubusercontent.com/.../cluster-overview.json

      spark-applications:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Spark K8s
        url: https://raw.githubusercontent.com/.../spark-applications.json

      executor-metrics:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Spark K8s
        url: https://raw.githubusercontent.com/.../executor-metrics.json

      sql-performance:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Spark K8s
        url: https://raw.githubusercontent.com/.../sql-performance.json

      resource-usage:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Spark K8s
        url: https://raw.githubusercontent.com/.../resource-usage.json
```

```json
// charts/observability/grafana/dashboards/cluster-overview.json (simplified)
{
  "dashboard": {
    "title": "Spark K8s Cluster Overview",
    "tags": ["spark", "k8s"],
    "timezone": "browser",
    "panels": [
      {
        "title": "Cluster Nodes",
        "type": "stat",
        "targets": [
          {
            "expr": "kube_node_info"
          }
        ]
      },
      {
        "title": "Running Pods",
        "type": "graph",
        "targets": [
          {
            "expr": "kube_pod_status_phase{namespace=~\"spark.*\",phase=\"Running\"}"
          }
        ]
      },
      {
        "title": "CPU Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\"spark.*\"}[5m])) by (namespace)"
          }
        ]
      },
      {
        "title": "Memory Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(container_memory_working_set_bytes{namespace=~\"spark.*\"}) by (namespace)"
          }
        ]
      }
    ]
  }
}
```

### Scope Estimate

- Files: 8
- Lines: ~500 (MEDIUM)
- Tokens: ~4000

### Constraints

- DO use Grafana for dashboards
- DO auto-provision dashboards from ConfigMaps
- DO use Prometheus/Loki/Jaeger datasources
- DO create 5+ dashboards
- DO NOT require manual dashboard setup

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 ‚Äî ‚úÖ

**Goal Achieved:** ______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### üéØ Goal Status

- [x] AC1: Grafana chart ‚Äî ‚úÖ Exists
- [ ] AC2‚ÄìAC4: Datasources ‚Äî ‚ùå values.yaml YAML syntax error (invalid JSON in jsonData)
- [x] AC5: 5+ dashboards ‚Äî ‚úÖ 7 ops dashboards
- [ ] AC6: Auto-provision ‚Äî ‚ö†Ô∏è Config present; typo prometheus-operato

**Goal Achieved:** ‚ùå Partial (helm template fails)

#### Issues

| # | Severity | Issue | Fix |
|---|----------|-------|-----|
| 1 | CRITICAL | grafana values.yaml invalid JSON (missing comma after POST) | Fix jsonData block |
| 2 | MEDIUM | prometheus-operato typo | prometheus-operator |
| 3 | MEDIUM | Multiple isDefault: true | Only one datasource default |
