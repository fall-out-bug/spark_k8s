---
ws_id: 00-016-04
feature: F16
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-016-01  # Metrics collection
  - 00-016-02  # Logging aggregation
---

## WS-00-016-04: Dashboards (Grafana)

### üéØ Goal

**What must WORK after completing this WS:**
- Grafana Helm chart –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- 5+ –¥–∞—à–±–æ—Ä–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ
- Prometheus datasource –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Loki datasource –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Jaeger datasource –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**Acceptance Criteria:**
- [ ] AC1: Grafana Helm chart —Å–æ–∑–¥–∞–Ω
- [ ] AC2: Prometheus datasource —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] AC3: Loki datasource —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] AC4: Jaeger datasource —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] AC5: 5+ dashboards —Å–æ–∑–¥–∞–Ω—ã
- [ ] AC6: Dashboards auto-provision

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Dependencies

WS-016-01, WS-016-02

### Dashboards List

> **Note on Dashboard Consolidation:**
> - **Spark dashboards** are embedded in Spark charts (`charts/spark-3.5/templates/monitoring/` and `charts/spark-4.1/templates/monitoring/`)
> - **Ops dashboards** are in `charts/observability/grafana/dashboards/` (backup, budget, chaos, cost, incident, slo)
> - This WS focuses on Grafana configuration; dashboard content is managed separately

**Spark Dashboards** (auto-provisioned from Spark charts):
1. **Spark Overview**: App status, stages, tasks (`grafana-dashboard-spark-overview.yaml`)
2. **Job Performance**: Job duration, stages, tasks (`grafana-dashboard-job-performance.yaml`)
3. **Executor Metrics**: Memory, CPU, GC, shuffle (`grafana-dashboard-executor-metrics.yaml`)
4. **Job Phase Timeline**: Stage timing visualization (`grafana-dashboard-job-phase-timeline.yaml`)
5. **Profiling**: Spark profiler metrics (`grafana-dashboard-profiling.yaml`)

**Ops Dashboards** (in `charts/observability/grafana/dashboards/`):
1. **Backup Status**: Backup health status
2. **Budget Status**: Cloud cost budget tracking
3. **Chaos Metrics**: Chaos engineering results
4. **Cost by Job**: Cost breakdown per Spark job
5. **Cost by Team**: Cost breakdown per team
6. **Incident Metrics**: Incident tracking
7. **SLO Forecast**: SLO/SLI predictions

### Code

```yaml
# charts/observability/grafana/values.yaml
grafana:
  enabled: true
  adminPassword: admin

  persistence:
    enabled: true
    size: 10Gi

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://prometheus:9090
        access: proxy
        isDefault: true
        editable: true

      - name: Loki
        type: loki
        url: http://loki:3100
        access: proxy
        editable: false
        jsonData: "{}"

      - name: Jaeger
        type: jaeger
        url: http://jaeger-query:16686
        access: proxy
        editable: false
        jsonData: "{}"

  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: spark-k8s
        orgId: 1
        folder: Spark K8s
        type: file
        disableDeletion: false
        options:
          path: /var/lib/grafana/dashboards/spark-k8s

      - name: ops
        orgId: 1
        folder: Operations
        type: file
        disableDeletion: false
        options:
          path: /var/lib/grafana/dashboards/ops

  dashboards:
    # Spark dashboards are auto-provisioned from Spark charts
    # via ConfigMaps in charts/spark-3.5/templates/monitoring/
    # and charts/spark-4.1/templates/monitoring/
    spark-k8s: {}

    # Ops dashboards from charts/observability/grafana/dashboards/
    ops:
      backup-status:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Operations
        file: dashboards/backup-status.json

      budget-status:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Operations
        file: dashboards/budget-status.json

      chaos-metrics:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Operations
        file: dashboards/chaos-metrics.json

      cost-by-job:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Operations
        file: dashboards/cost-by-job.json

      cost-by-team:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Operations
        file: dashboards/cost-by-team.json

      incident-metrics:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Operations
        file: dashboards/incident-metrics.json

      slo-forecast:
        gnetId: null
        revision: 1
        datasource: Prometheus
        folder: Operations
        file: dashboards/slo-forecast.json
```

```json
// charts/observability/grafana/dashboards/cluster-overview.json (simplified)
{
  "dashboard": {
    "title": "Spark K8s Cluster Overview",
    "tags": ["spark", "k8s"],
    "timezone": "browser",
    "panels": [
      {
        "title": "Cluster Nodes",
        "type": "stat",
        "targets": [
          {
            "expr": "kube_node_info"
          }
        ]
      },
      {
        "title": "Running Pods",
        "type": "graph",
        "targets": [
          {
            "expr": "kube_pod_status_phase{namespace=~\"spark.*\",phase=\"Running\"}"
          }
        ]
      },
      {
        "title": "CPU Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\"spark.*\"}[5m])) by (namespace)"
          }
        ]
      },
      {
        "title": "Memory Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(container_memory_working_set_bytes{namespace=~\"spark.*\"}) by (namespace)"
          }
        ]
      }
    ]
  }
}
```

### Scope Estimate

- Files: 8
- Lines: ~500 (MEDIUM)
- Tokens: ~4000

### Constraints

- DO use Grafana for dashboards
- DO auto-provision dashboards from ConfigMaps
- DO use Prometheus/Loki/Jaeger datasources
- DO create 5+ dashboards
- DO NOT require manual dashboard setup

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 ‚Äî ‚úÖ

**Goal Achieved:** ______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### üéØ Goal Status

- [x] AC1: Grafana chart ‚Äî ‚úÖ Exists
- [ ] AC2‚ÄìAC4: Datasources ‚Äî ‚ùå values.yaml YAML syntax error (invalid JSON in jsonData)
- [x] AC5: 5+ dashboards ‚Äî ‚úÖ 7 ops dashboards
- [ ] AC6: Auto-provision ‚Äî ‚ö†Ô∏è Config present; typo prometheus-operato

**Goal Achieved:** ‚ùå Partial (helm template fails)

#### Issues

| # | Severity | Issue | Fix |
|---|----------|-------|-----|
| 1 | CRITICAL | grafana values.yaml invalid JSON (missing comma after POST) | Fix jsonData block |
| 2 | MEDIUM | prometheus-operato typo | prometheus-operator |
| 3 | MEDIUM | Multiple isDefault: true | Only one datasource default |
