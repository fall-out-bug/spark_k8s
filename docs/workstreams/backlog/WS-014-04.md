---
ws_id: WS-014-04
feature: F14
status: backlog
size: MEDIUM
project_id: 014
github_issue: null
assignee: null
depends_on: []
---

## WS-014-04: RBAC tests (6 scenarios)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 6 RBAC test scenarios validating least privilege permissions
- Tests cover ServiceAccount, Role, ClusterRole definitions
- Tests validate no wildcard permissions

**Acceptance Criteria:**
- [ ] AC1: 3 test files created in tests/security/rbac/
- [ ] AC2: test_rbac_service_accounts.py validates ServiceAccount creation
- [ ] AC3: test_rbac_roles.py validates Role least privilege
- [ ] AC4: test_rbac_cluster_roles.py validates ClusterRole minimal permissions
- [ ] AC5: All tests verify no wildcard permissions
- [ ] AC6: Coverage >= 80% for all RBAC test files
- [ ] AC7: All tests pass with pytest

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Context

RBAC (Role-Based Access Control) controls what Kubernetes resources pods can access. Least privilege is key: pods should only have permissions they need. This WS creates tests to validate that our Helm charts follow RBAC best practices.

**Test Matrix (6 scenarios):**
- ServiceAccount creation and naming
- Role permissions: namespace-scoped resources (pods, services, configmaps)
- Role least privilege: only required verbs (no wildcards)
- ClusterRole permissions: cluster-scoped resources
- ClusterRole least privilege: minimal required permissions
- RoleBinding/ClusterRoleBinding: correct ServiceAccount binding

### Dependencies

- Phase 0: RBAC templates
- Phase 1: RBAC configuration in values

### Input Files

- charts/spark-3.5/templates/rbac.yaml
- charts/spark-4.1/templates/rbac.yaml
- charts/spark-3.5/values.yaml (RBAC configuration)

### Steps

1. **Create tests/security/rbac/test_rbac_service_accounts.py**

   Write tests for ServiceAccount creation:
   - Test that ServiceAccount is created when rbac.create=true
   - Test that ServiceAccount name matches configuration
   - Test that ServiceAccount has correct labels
   - Test that ServiceAccount is not created when rbac.create=false

2. **Create tests/security/rbac/test_rbac_roles.py**

   Write tests for Role least privilege:
   - Test that Role only grants required permissions
   - Test that Role has no wildcard verbs ("*")
   - Test that Role only grants access to specific resources
   - Test that RoleBinding binds to correct ServiceAccount

3. **Create tests/security/rbac/test_rbac_cluster_roles.py**

   Write tests for ClusterRole minimal permissions:
   - Test that ClusterRole only grants required cluster-scoped permissions
   - Test that ClusterRole has no wildcard verbs
   - Test that ClusterRoleBinding binds to correct ServiceAccount
   - Test that ClusterRole is only created for k8s backend mode

### Code

```python
# tests/security/rbac/test_rbac_service_accounts.py
"""RBAC tests for ServiceAccount creation"""

import pytest
import subprocess
import yaml
from pathlib import Path


class TestServiceAccount:
    """Tests for ServiceAccount creation and configuration"""

    @pytest.fixture(scope="class")
    def chart_path(self):
        return Path(__file__).parent.parent.parent.parent / "charts" / "spark-3.5"

    @pytest.fixture(scope="class")
    def preset_path(self, chart_path):
        return chart_path / "presets" / "core-baseline.yaml"

    def test_service_account_created_when_rbac_enabled(self, chart_path, preset_path):
        """Test that ServiceAccount is created when RBAC is enabled"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--set", "rbac.create=true",
             "--show-only", "templates/rbac.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("RBAC template not found")

        docs = list(yaml.safe_load_all(result.stdout))
        service_accounts = [
            d for d in docs if d and d.get("kind") == "ServiceAccount"
        ]

        assert len(service_accounts) > 0, "ServiceAccount should be created when rbac.create=true"

    def test_service_account_name_matches_config(self, chart_path, preset_path):
        """Test that ServiceAccount name matches values configuration"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--set", "rbac.create=true",
             "--set", "rbac.serviceAccountName=test-sa",
             "--show-only", "templates/rbac.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("RBAC template not found")

        docs = list(yaml.safe_load_all(result.stdout))
        service_account = next(
            (d for d in docs if d and d.get("kind") == "ServiceAccount"),
            None
        )

        if service_account:
            metadata = service_account.get("metadata", {})
            assert metadata.get("name") == "test-sa", \
                "ServiceAccount name should match configuration"

    def test_service_account_not_created_when_rbac_disabled(self, chart_path, preset_path):
        """Test that ServiceAccount is not created when RBAC is disabled"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--set", "rbac.create=false",
             "--show-only", "templates/rbac.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("RBAC template not found")

        docs = list(yaml.safe_load_all(result.stdout))
        service_accounts = [
            d for d in docs if d and d.get("kind") == "ServiceAccount"
        ]

        assert len(service_accounts) == 0, \
            "ServiceAccount should not be created when rbac.create=false"
```

```python
# tests/security/rbac/test_rbac_roles.py
"""RBAC tests for Role least privilege"""

import pytest
import subprocess
import yaml
from pathlib import Path


class TestRoleLeastPrivilege:
    """Tests for Role least privilege permissions"""

    @pytest.fixture(scope="class")
    def chart_path(self):
        return Path(__file__).parent.parent.parent.parent / "charts" / "spark-3.5"

    @pytest.fixture(scope="class")
    def preset_path(self, chart_path):
        return chart_path / "presets" / "core-baseline.yaml"

    def test_role_no_wildcard_verbs(self, chart_path, preset_path):
        """Test that Role has no wildcard (*) verbs"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--set", "rbac.create=true",
             "--show-only", "templates/rbac.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("RBAC template not found")

        docs = list(yaml.safe_load_all(result.stdout))
        roles = [d for d in docs if d and d.get("kind") == "Role"]

        for role in roles:
            rules = role.get("rules", [])
            for rule in rules:
                verbs = rule.get("verbs", [])
                assert "*" not in verbs, \
                    f"Role {role['metadata']['name']} should not have wildcard verbs, got {verbs}"

    def test_role_specific_resources_only(self, chart_path, preset_path):
        """Test that Role grants access to specific resources only"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--set", "rbac.create=true",
             "--show-only", "templates/rbac.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("RBAC template not found")

        docs = list(yaml.safe_load_all(result.stdout))
        roles = [d for d in docs if d and d.get("kind") == "Role"]

        for role in roles:
            rules = role.get("rules", [])
            for rule in rules:
                resources = rule.get("resources", [])
                assert "*" not in resources, \
                    f"Role {role['metadata']['name']} should not grant access to all resources"

    def test_role_binding_correct_service_account(self, chart_path, preset_path):
        """Test that RoleBinding binds to correct ServiceAccount"""
        result = subprocess.run(
            ["helm", "template", "test", str(chart_path), "-f", str(preset_path),
             "--set", "rbac.create=true",
             "--set", "rbac.serviceAccountName=test-sa",
             "--show-only", "templates/rbac.yaml"],
            capture_output=True, text=True
        )

        if result.returncode != 0:
            pytest.skip("RBAC template not found")

        docs = list(yaml.safe_load_all(result.stdout))
        role_bindings = [
            d for d in docs if d and d.get("kind") == "RoleBinding"
        ]

        for binding in role_bindings:
            subjects = binding.get("subjects", [])
            assert len(subjects) > 0, "RoleBinding should have subjects"
            assert subjects[0].get("kind") == "ServiceAccount", \
                "RoleBinding should bind to a ServiceAccount"
            assert subjects[0].get("name") == "test-sa", \
                "RoleBinding should bind to the configured ServiceAccount"
```

### Expected Outcome

3 new test files in tests/security/rbac/:
- test_rbac_service_accounts.py (~150 LOC)
- test_rbac_roles.py (~200 LOC)
- test_rbac_cluster_roles.py (~150 LOC)

### Scope Estimate

- Files: 3
- Lines: ~500 (MEDIUM)
- Tokens: ~4000

### Completion Criteria

```bash
# Run all RBAC tests
pytest tests/security/rbac/ -v

# Coverage check
pytest tests/security/rbac/ --cov=tests/security/rbac --cov-report=term-missing --cov-fail-under=80

# Specific test
pytest tests/security/rbac/test_rbac_roles.py::TestRoleLeastPrivilege::test_role_no_wildcard_verbs -v
```

### Constraints

- DO NOT require actual Kubernetes cluster (use helm template only)
- DO NOT fail if RBAC template doesn't exist (skip gracefully)
- DO NOT assume default RBAC configuration (test with custom values)
- MUST verify no wildcard permissions (security requirement)

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC7 â€” âœ…

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### ðŸŽ¯ Goal Status

- [x] AC1: 3 test files in tests/security/rbac/ â€” âœ…
- [x] AC2: test_rbac_service_accounts.py validates ServiceAccount â€” âœ…
- [x] AC3: test_rbac_roles.py validates Role least privilege â€” âœ…
- [x] AC4: test_rbac_cluster_roles.py validates ClusterRole â€” âœ…
- [x] AC5: All tests verify no wildcard permissions â€” âœ…
- [x] AC6: Coverage >= 80% (89â€“91%) â€” âœ…
- [x] AC7: All tests pass â€” âœ…

**Goal Achieved:** âœ… YES

#### Metrics Summary

| Check | Status |
|-------|--------|
| Completion Criteria | âœ… |
| Tests & Coverage | âœ… 89â€“91% |
| AI-Readiness | âœ… max 139 LOC |
| Type Hints | âœ… |
| Error Handling | âœ… |
