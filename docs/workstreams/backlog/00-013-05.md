---
ws_id: 00-013-05
feature: F13
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Helm charts
  - 00-007-01  # Security templates
---

## WS-00-013-05: Security stability (4 scenarios)

### üéØ Goal

**What must WORK after completing this WS:**
- 4 security stability scenarios (PSS, SCC, OpenShift)
- Validate security settings under sustained load
- No performance degradation from security policies

**Acceptance Criteria:**
- [ ] AC1: 4 security stability scenarios created
- [ ] AC2: PSS restricted mode stable under load
- [ ] AC3: SCC policies stable under load
- [ ] AC4: OpenShift presets stable under load
- [ ] AC5: Performance within 10% of non-secure baseline
- [ ] AC6: No policy violations under load

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Scenarios

| Scenario | Security Mode | Preset | Duration | Check |
|----------|---------------|--------|----------|-------|
| 1 | PSS | restricted | 30 min | Pod constraints valid |
| 2 | SCC | anyuid | 30 min | Container permissions stable |
| 3 | OpenShift | restricted-v2 | 30 min | SecurityContextConstraints valid |
| 4 | Custom | baseline | 30 min | seccomp profiles stable |

### Dependencies

- WS-006-01 (Helm charts)
- WS-007-01 (Security templates)

### Code

```python
# tests/load/security/test_pss_stability.py
import pytest
from kubernetes import client, config

@pytest.mark.timeout(2400)
def test_pss_restricted_stability(spark_connect_client, k8s_core_api):
    """
    Sustained load test with PSS restricted mode
    Validates security policies don't break under load
    """
    duration_sec = 1800
    interval_sec = 1

    start_time = datetime.now()
    end_time = start_time + timedelta(seconds=duration_sec)

    metrics = {
        "queries_total": 0,
        "queries_success": 0,
        "policy_violations": 0
    }

    while datetime.now() < end_time:
        try:
            # Run query
            spark_connect_client.sql("""
                SELECT COUNT(*) FROM nyc_taxi
            """).collect()

            metrics["queries_success"] += 1

            # Check pod security context
            pods = k8s_core_api.list_namespaced_pod(
                namespace="spark-load-test",
                label_selector="app.kubernetes.io/component=executor"
            )

            for pod in pods.items:
                # Verify no privileged containers
                for container in pod.spec.containers:
                    if container.security_context and container.security_context.privileged:
                        metrics["policy_violations"] += 1

                # Verify runAsUser is set (not root)
                if pod.spec.security_context:
                    if pod.spec.security_context.run_as_user == 0:
                        metrics["policy_violations"] += 1

        except Exception as e:
            pass
        finally:
            metrics["queries_total"] += 1
            time.sleep(interval_sec)

    # Assertions
    error_rate = (metrics["queries_total"] - metrics["queries_success"]) / metrics["queries_total"]
    assert error_rate < 0.01, f"Error rate too high: {error_rate:.2%}"

    assert metrics["policy_violations"] == 0, f"Policy violations detected: {metrics['policy_violations']}"

    return metrics
```

### Scope Estimate

- Files: 6
- Lines: ~600 (MEDIUM)
- Tokens: ~4500

### Constraints

- DO use same security policies as production
- DO monitor for policy violations
- DO compare with non-secure baseline
- DO NOT relax security for performance

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 ‚Äî ‚úÖ

**Goal Achieved:** ______
