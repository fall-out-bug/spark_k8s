---
ws_id: 00-008-07
feature: F08
status: backlog
size: SMALL
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-008-02  # Standalone chart scenarios
---

## WS-00-008-07: Parallel execution improvements

### üéØ Goal

**What must WORK after completing this WS:**
- Improved parallel execution support in run-smoke-tests.sh
- Intelligent skip logic for missing resources
- Aggregated logging for parallel runs
- Retry mechanism for flaky tests

**Acceptance Criteria:**
- [ ] AC1: GPU scenarios skip when no GPU nodes
- [ ] AC2: Iceberg scenarios skip when no Hive Metastore
- [ ] AC3: Parallel logs aggregated to single file
- [ ] AC4: Failed scenarios can be retried with --retry flag
- [ ] AC5: Resource-aware scheduling (group compatible scenarios)

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Context

Current parallel execution is basic. This WS improves reliability and usability of parallel smoke test runs.

### Dependencies

- WS-008-02: Standalone chart scenarios (for testing parallel execution)

### Input Files

- scripts/tests/smoke/run-smoke-tests.sh
- scripts/tests/lib/validation.sh

### Steps

1. **Enhanced skip logic**

2. **Aggregated logging**

3. **Retry mechanism**

4. **Resource-aware scheduling**

### Code

```bash
# scripts/tests/lib/parallel.sh (new file)

# Resource detection
detect_cluster_resources() {
    local resources=()
    resources+=("gpu:$(check_gpu_nodes)")
    resources+=("iceberg:$(check_hive_metastore)")
    resources+=("standalone:$(check_standalone_available)")

    echo "${resources[@]}"
}

# Scenario categorization
categorize_scenario() {
    local scenario_file="$1"

    local features
    features=$(parse_yaml_frontmatter "$scenario_file" "features")

    if [[ "$features" =~ "gpu" ]]; then
        echo "gpu"
    elif [[ "$features" =~ "iceberg" ]]; then
        echo "iceberg"
    elif [[ "$features" =~ "standalone" ]]; then
        echo "standalone"
    else
        echo "baseline"
    fi
}

# Parallel execution with resource awareness
run_scenarios_parallel_smart() {
    local scenario_files=("$@")
    declare -A pids
    declare -A categories

    # Categorize scenarios
    for scenario_file in "${scenario_files[@]}"; do
        local category
        category=$(categorize_scenario "$scenario_file")
        categories["$scenario_file"]=$category
    done

    # Group by resource requirements
    local baseline_scenarios=()
    local gpu_scenarios=()
    local iceberg_scenarios=()
    local standalone_scenarios=()

    for scenario_file in "${scenario_files[@]}"; do
        local cat="${categories[$scenario_file]}"
        case "$cat" in
            gpu) gpu_scenarios+=("$scenario_file") ;;
            iceberg) iceberg_scenarios+=("$scenario_file") ;;
            standalone) standalone_scenarios+=("$scenario_file") ;;
            *) baseline_scenarios+=("$scenario_file") ;;
        esac
    done

    # Execute groups sequentially, scenarios in parallel
    execute_group "${baseline_scenarios[@]}"
    execute_group "${gpu_scenarios[@]}"
    execute_group "${iceberg_scenarios[@]}"
    execute_group "${standalone_scenarios[@]}"
}

execute_group() {
    local scenarios=("$@")

    if [[ ${#scenarios[@]} -eq 0 ]]; then
        return
    fi

    log_info "Executing group: ${#scenarios[@]} scenarios"

    # Run in parallel with aggregated logging
    PARALLEL_LOG_DIR="/tmp/smoke-parallel-$$"
    mkdir -p "$PARALLEL_LOG_DIR"

    local pids=()
    for scenario_file in "${scenarios[@]}"; do
        local scenario_name
        scenario_name=$(parse_yaml_frontmatter "$scenario_file" "name")

        (
            bash "$scenario_file" 2>&1 | tee "$PARALLEL_LOG_DIR/${scenario_name}.log"
            echo $? > "$PARALLEL_LOG_DIR/${scenario_name}.exit"
        ) &
        pids+=($!)
    done

    # Wait for all
    local failed=0
    for i in "${!pids[@]}"; do
        wait "${pids[$i]}" || ((failed++))
    done

    # Aggregate results
    echo ""
    echo "=== Parallel Execution Summary ==="
    for log_file in "$PARALLEL_LOG_DIR"/*.log; do
        local scenario_name
        scenario_name=$(basename "$log_file" .log)
        local exit_code
        exit_code=$(cat "$PARALLEL_LOG_DIR/${scenario_name}.exit")

        if [[ "$exit_code" -eq 0 ]]; then
            echo "‚úÖ $scenario_name"
        else
            echo "‚ùå $scenario_name (exit: $exit_code)"
        fi
    done

    # Cleanup
    rm -rf "$PARALLEL_LOG_DIR"

    return $failed
}

# Retry mechanism
retry_failed_scenarios() {
    local failed_scenarios=("$@")

    if [[ ${#failed_scenarios[@]} -eq 0 ]]; then
        log_info "No failed scenarios to retry"
        return 0
    fi

    log_warning "Retrying ${#failed_scenarios[@]} failed scenarios..."

    local still_failed=0
    for scenario_file in "${failed_scenarios[@]}"; do
        local scenario_name
        scenario_name=$(parse_yaml_frontmatter "$scenario_file" "name")

        log_info "Retrying: $scenario_name"
        if bash "$scenario_file"; then
            log_success "Retry passed: $scenario_name"
        else
            log_error "Retry failed: $scenario_name"
            ((still_failed++))
        fi
    done

    return $still_failed
}
```

### Scope Estimate

- Files: 2 (run-smoke-tests.sh, lib/parallel.sh)
- Lines: ~600 (SMALL)
- Tokens: ~4500

### Completion Criteria

```bash
# Test parallel execution with GPU skip
bash scripts/tests/smoke/run-smoke-tests.sh --parallel --component jupyter --features gpu

# Verify aggregated logging
ls -lh /tmp/smoke-parallel-*/

# Test retry
bash scripts/tests/smoke/run-smoke-tests.sh --parallel --retry
```

### Constraints

- DO NOT change sequential execution (must still work)
- DO NOT require external tools (use only bash)

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC5 ‚Äî ‚úÖ

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### üéØ Goal Status

- [x] AC1: GPU scenarios skip when no GPU nodes ‚Äî ‚úÖ (parallel.sh check_gpu_nodes)
- [x] AC2: Iceberg scenarios skip when no Hive Metastore ‚Äî ‚úÖ (check_hive_metastore)
- [x] AC3: Parallel logs aggregated ‚Äî ‚úÖ (AGGREGATE_LOGS)
- [x] AC4: --retry flag for failed scenarios ‚Äî ‚úÖ
- [x] AC5: Resource-aware scheduling ‚Äî ‚úÖ (detect_cluster_resources)

**Goal Achieved:** ‚úÖ YES

#### Metrics Summary

| Check | Target | Actual | Status |
|-------|--------|--------|--------|
| Goal Achievement | 100% | 5/5 AC | ‚úÖ |
| parallel.sh | exists | ‚úÖ | ‚úÖ |
| run-smoke-tests.sh --parallel, --retry | ‚úÖ | ‚úÖ | ‚úÖ |
| TODO/FIXME | 0 | 0 | ‚úÖ |

#### Verdict

‚úÖ APPROVED
