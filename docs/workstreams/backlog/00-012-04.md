---
ws_id: 00-012-04
feature: F12
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Phase 0: Helm charts
  - 00-006-06  # Phase 0: GPU feature templates
  - 00-006-07  # Phase 0: Iceberg feature templates
  - 00-022-01  # Phase 1: Security templates
  - 00-012-02  # GPU E2E
  - 00-012-03  # Iceberg E2E
---

## WS-00-012-04: GPU+Iceberg E2E (8 scenarios)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 8 GPU+Iceberg combined E2E test scenarios
- Tests validate Spark 4.1.0, 4.1.1 Ã— Airflow Ã— connect-k8s Ã— GPU+Iceberg
- Combined RAPIDS acceleration + Iceberg table operations

**Acceptance Criteria:**
- [ ] AC1: 8 GPU+Iceberg E2E scenarios created (4.1.0, 4.1.1 Ã— Airflow Ã— 2 configurations)
- [ ] AC2: GPU-accelerated queries on Iceberg tables work
- [ ] AC3: Iceberg time travel with GPU operations validated
- [ ] AC4: Combined metrics collected (GPU + Iceberg)
- [ ] AC5: All scenarios complete with timeout < 1200s

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Context

GPU+Iceberg E2E tests validate the combination of RAPIDS GPU acceleration with Apache Iceberg table operations. This is a complex scenario requiring both GPU resources and Iceberg catalog.

### Dependencies

- Phase 0 (F06): GPU and Iceberg feature templates
- Phase 1 (F07): Security templates
- Phase 5 (F11): GPU+Iceberg runtime images
- WS-00-012-02: GPU E2E tests
- WS-00-012-03: Iceberg E2E tests

### Input Files

- `scripts/tests/e2e/conftest.py` â€” Base E2E fixtures
- `scripts/tests/e2e/test_*_gpu_*.py` â€” GPU test patterns
- `scripts/tests/e2e/test_*_iceberg_*.py` â€” Iceberg test patterns

### Steps

1. **Create combined GPU+Iceberg fixtures:**
   - Reuse GPU availability check
   - Reuse Iceberg catalog setup
   - Add combined initialization

2. **Implement GPU+Iceberg E2E test scenarios:**
   - `test_airflow_gpu_iceberg_410.py` â€” GPU+Iceberg, Spark 4.1.0
   - `test_airflow_gpu_iceberg_411.py` â€” GPU+Iceberg, Spark 4.1.1

3. **Add combined test cases:**
   - GPU-accelerated queries on Iceberg tables
   - Time travel with GPU operations
   - Schema evolution with GPU-accelerated reads

4. **Implement combined metrics collection:**
   - GPU utilization (from GPU tests)
   - Iceberg table metrics (from Iceberg tests)
   - Combined performance metrics

5. **Validate locally (requires GPU + Iceberg):**
   - Run pytest on GPU+Iceberg scenarios
   - Verify GPU is used with Iceberg tables
   - Check time travel works with GPU queries

### Code

**Combined fixture example:**

```python
@pytest.fixture(scope="function")
def gpu_iceberg_table(spark_session, dataset_path, gpu_available):
    """Create Iceberg table with GPU support."""
    import tempfile
    warehouse = tempfile.mkdtemp(prefix="iceberg_gpu_warehouse_")

    # Configure Iceberg
    spark_session.conf.set("spark.sql.catalog.local", "org.apache.iceberg.spark.SparkCatalog")
    spark_session.conf.set("spark.sql.catalog.local.type", "hadoop")
    spark_session.conf.set("spark.sql.catalog.local.warehouse", warehouse)
    spark_session.conf.set("spark.sql.extensions", "org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions")

    # Enable GPU on Iceberg
    spark_session.conf.set("spark.rapids.sql.enabled", "true")
    spark_session.conf.set("spark.rapids.sql.incompatibleOps.enabled", "true")

    # Create Iceberg table
    df = spark_session.read.parquet(dataset_path)
    df.writeTo("local.nyc_taxi").using("iceberg").create()

    yield {"table": "local.nyc_taxi", "warehouse": warehouse}

    # Cleanup
    import shutil
    shutil.rmtree(warehouse, ignore_errors=True)

@pytest.fixture(scope="function")
def gpu_iceberg_metrics():
    """Collect combined GPU + Iceberg metrics."""
    from scripts.tests.e2e.test_gpu import get_gpu_stats
    from scripts.tests.e2e.test_iceberg import get_iceberg_metrics

    yield {}

    return {
        "gpu": get_gpu_stats(),
        "iceberg": get_iceberg_metrics("local.nyc_taxi")
    }
```

### Expected Outcome

- Files: 2 test modules
- All 8 scenarios (2 modules Ã— 4 test cases) pass
- Combined GPU+Iceberg operations validated

### Scope Estimate

- Files: ~3
- Lines: ~500 (MEDIUM)
- Tokens: ~2000

### Completion Criteria

```bash
# Run GPU+Iceberg E2E tests
pytest scripts/tests/e2e/ -v --timeout=1200 -k "gpu_iceberg"

# Verify both GPU and Iceberg are used
# Check test output for gpu_utilization > 0 and iceberg metrics
```

### Constraints

- Tests skip gracefully if GPU or Iceberg not available
- DO NOT modify existing GPU or Iceberg tests
- MUST validate both features are actually used

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC5 â€” âœ…

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______
