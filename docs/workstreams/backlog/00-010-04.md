---
ws_id: 00-010-04
feature: F10
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-010-01  # Spark core layers
---

## WS-00-010-04: JARs layers (RAPIDS, Iceberg) + tests

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- RAPIDS JARs intermediate layer (for GPU)
- Iceberg JARs intermediate layer
- JARs downloaded from Maven repositories
- Unit tests validate JAR availability

**Acceptance Criteria:**
- [ ] AC1: docker/docker-intermediate/jars-rapids/Dockerfile created
- [ ] AC2: docker/docker-intermediate/jars-iceberg/Dockerfile created
- [ ] AC3: RAPIDS plugin JARs downloaded from NVIDIA
- [ ] AC4: Iceberg JARs downloaded from Apache
- [ ] AC5: JARs placed in correct Spark classpath locations
- [ ] AC6: tests validate JAR loading

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Context

RAPIDS and Iceberg require additional JARs for Spark integration. This WS creates intermediate layers with these JARs pre-downloaded.

### Dependencies

- WS-010-01: Spark core layers (JARs go into Spark jars directory)

### Code

```dockerfile
# docker/docker-intermediate/jars-rapids/Dockerfile
ARG BASE_IMAGE=spark-k8s-spark-3.5.7-core:latest
FROM ${BASE_IMAGE}

LABEL maintainer="spark-k8s"
LABEL description="Spark K8s - RAPIDS Plugin JARs Intermediate Layer"
LABEL version="1.0.0"

# RAPIDS version
ARG RAPIDS_VERSION=23.12.0
ARG CUDA_VERSION=12.0
ARG SPARK_VERSION=3.5.7

# Download RAPIDS plugin JARs
RUN mkdir -p ${SPARK_HOME}/jars && \
    wget -q https://repo1.maven.org/maven2/com/nvidia/rapids-4-spark_2.12/${RAPIDS_VERSION}/rapids-4-spark_2.12-${RAPIDS_VERSION}.jar \
        -O ${SPARK_HOME}/jars/rapids-4-spark_2.12-${RAPIDS_VERSION}.jar && \
    wget -q https://repo1.maven.org/maven2/ai/rapids/cudf/${RAPIDS_VERSION}/cudf-${RAPIDS_VERSION}.jar \
        -O ${SPARK_HOME}/jars/cudf-${RAPIDS_VERSION}.jar && \
    echo "RAPIDS plugin JARs installed: ${RAPIDS_VERSION}"

# Verify JARs
RUN ls -la ${SPARK_HOME}/jars/rapids*.jar && \
    ls -la ${SPARK_HOME}/jars/cudf*.jar

# Set Spark Rapids configuration
ENV SPARK_RAPIDS_VERSION=${RAPIDS_VERSION}
ENV SPARK_RAPIDS_JAR=${SPARK_HOME}/jars/rapids-4-spark_2.12-${RAPIDS_VERSION}.jar

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD ls -la ${SPARK_HOME}/jars/rapids*.jar >/dev/null 2>&1 || exit 1

# Working directory
WORKDIR /opt/spark

# Default shell
SHELL ["/bin/bash", "-c"]
```

```dockerfile
# docker/docker-intermediate/jars-iceberg/Dockerfile
ARG BASE_IMAGE=spark-k8s-spark-3.5.7-core:latest
FROM ${BASE_IMAGE}

LABEL maintainer="spark-k8s"
LABEL description="Spark K8s - Apache Iceberg JARs Intermediate Layer"
LABEL version="1.0.0"

# Iceberg version
ARG ICEBERG_VERSION=1.4.0
ARG SPARK_VERSION=3.5.7

# Download Iceberg JARs
RUN mkdir -p ${SPARK_HOME}/jars && \
    wget -q https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-spark-runtime-${SPARK_VERSION}_${SCALA_VERSION}/${ICEBERG_VERSION}/iceberg-spark-runtime-${SPARK_VERSION}_${SCALA_VERSION}-${ICEBERG_VERSION}.jar \
        -O ${SPARK_HOME}/jars/iceberg-spark-runtime.jar && \
    echo "Iceberg JAR installed: ${ICEBERG_VERSION}"

# Download Iceberg AWS bundle
RUN wget -q https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-aws-bundle/${ICEBERG_VERSION}/iceberg-aws-bundle-${ICEBERG_VERSION}.jar \
        -O ${SPARK_HOME}/jars/iceberg-aws-bundle.jar || echo "AWS bundle download failed (optional)"

# Verify JARs
RUN ls -la ${SPARK_HOME}/jars/iceberg*.jar

# Set Iceberg configuration
ENV SPARK_SQL_CATALOG_IMPLEMENTATION=org.apache.iceberg.spark.SparkCatalog
ENV SPARK_SQL_EXTENSIONS=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD ls -la ${SPARK_HOME}/jars/iceberg*.jar >/dev/null 2>&1 || exit 1

# Working directory
WORKDIR /opt/spark

# Default shell
SHELL ["/bin/bash", "-c"]
```

```bash
#!/bin/bash
# docker/docker-intermediate/test-jars.sh

set -e

JAR_TYPE="${1:-rapids}"
IMAGE="spark-k8s-jars-${JAR_TYPE}:latest"

echo "Testing JARs layer (${JAR_TYPE}): $IMAGE"

# Test 1: Image exists
echo "Test 1: Check image exists"
docker images "$IMAGE" --format "{{.Repository}}:{{.Tag}}" | grep -q "$IMAGE" || {
    echo "FAIL: Image not found"
    exit 1
}
echo "PASS: Image exists"

# Test 2: JAR files present
echo "Test 2: Check JAR files"
if [ "$JAR_TYPE" = "rapids" ]; then
    docker run --rm "$IMAGE" bash -c 'ls -la ${SPARK_HOME}/jars/rapids*.jar' || {
        echo "FAIL: RAPIDS JARs not found"
        exit 1
    }
    echo "PASS: RAPIDS JARs present"
elif [ "$JAR_TYPE" = "iceberg" ]; then
    docker run --rm "$IMAGE" bash -c 'ls -la ${SPARK_HOME}/jars/iceberg*.jar' || {
        echo "FAIL: Iceberg JARs not found"
        exit 1
    }
    echo "PASS: Iceberg JARs present"
fi

# Test 3: JAR file validity
echo "Test 3: Check JAR file validity"
docker run --rm "$IMAGE" bash -c 'jar tf ${SPARK_HOME}/jars/*.jar | head -5' || {
    echo "FAIL: JAR files are not valid"
    exit 1
}
echo "PASS: JAR files valid"

echo ""
echo "All tests passed! âœ…"
```

### Expected Outcome

- `docker/docker-intermediate/jars-rapids/` with Dockerfile
- `docker/docker-intermediate/jars-iceberg/` with Dockerfile
- Test script for both
- Images with JARs in correct classpath

### Scope Estimate

- Files: 5
- Lines: ~700 (MEDIUM)
- Tokens: ~5000

### Constraints

- DO NOT include JARs in base images (use intermediate layers)
- DO require WS-010-01 completion
- DO verify JAR checksums when downloading

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 â€” âœ…

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______
