---
ws_id: 00-014-03
feature: F14
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-006-01  # Helm charts
  - 00-007-01  # Security templates
---

## WS-00-014-03: Network policies (6 scenarios)

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- 6 network policy test scenarios
- default-deny + explicit allow validation
- Component-specific network rules

**Acceptance Criteria:**
- [ ] AC1: 6 network policy test scenarios created
- [ ] AC2: Default-deny ingress/egress validated
- [ ] AC3: Explicit allow rules for Spark components
- [ ] AC4: MinIO/PostgreSQL access rules validated
- [ ] AC5: No overly permissive policies
- [ ] AC6: All required traffic allowed

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Scenarios

| Scenario | Policy Type | Direction | Target | Check |
|----------|-------------|-----------|--------|-------|
| 1 | default-deny | ingress | All pods | Blocks all traffic |
| 2 | default-deny | egress | All pods | Blocks all traffic |
| 3 | explicit-allow | ingress | Spark Connect | Allows client traffic |
| 4 | explicit-allow | egress | MinIO | Allows S3 access |
| 5 | explicit-allow | egress | PostgreSQL | Allows DB access |
| 6 | explicit-allow | ingress | Jupyter | Allows UI access |

### Dependencies

- WS-006-01 (Helm charts)
- WS-007-01 (Security templates)

### Code

```python
# tests/security/network/test_network_default_deny.py
import pytest
import yaml

def test_network_default_deny_ingress(helm_chart_path):
    """
    Validate default-deny ingress policy is applied
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "networkPolicy.enabled=true",
        "--set", "networkPolicy.defaultDeny=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))
    network_policies = [doc for doc in docs if doc.get("kind") == "NetworkPolicy"]

    # Find default-deny policy
    default_deny = None
    for np in network_policies:
        if np["metadata"]["name"] == "default-deny-ingress":
            default_deny = np
            break

    assert default_deny is not None, "default-deny-ingress policy not found"

    # Validate policy blocks all ingress
    pod_selector = default_deny["spec"]["podSelector"]
    assert pod_selector == {}, "default-deny should match all pods"

    policy_types = default_deny["spec"].get("policyTypes", [])
    assert "Ingress" in policy_types, "default-deny should restrict Ingress"

    # No ingress rules means block all
    ingress_rules = default_deny["spec"].get("ingress", [])
    assert len(ingress_rules) == 0, "default-deny should have no ingress rules (block all)"

def test_network_default_deny_egress(helm_chart_path):
    """
    Validate default-deny egress policy is applied
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "networkPolicy.enabled=true",
        "--set", "networkPolicy.defaultDeny=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))
    network_policies = [doc for doc in docs if doc.get("kind") == "NetworkPolicy"]

    default_deny_egress = None
    for np in network_policies:
        if np["metadata"]["name"] == "default-deny-egress":
            default_deny_egress = np
            break

    assert default_deny_egress is not None, "default-deny-egress policy not found"

    policy_types = default_deny_egress["spec"].get("policyTypes", [])
    assert "Egress" in policy_types, "default-deny should restrict Egress"

def test_network_explicit_allow_spark_connect(helm_chart_path):
    """
    Validate explicit allow rules for Spark Connect
    """
    cmd = [
        "helm", "template", "spark-4.1",
        helm_chart_path,
        "--set", "sparkConnect.enabled=true",
        "--set", "networkPolicy.enabled=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))
    network_policies = [doc for doc in docs if doc.get("kind") == "NetworkPolicy"]

    # Find Spark Connect policy
    connect_policy = None
    for np in network_policies:
        if "spark-connect" in np["metadata"]["name"]:
            connect_policy = np
            break

    assert connect_policy is not None, "spark-connect network policy not found"

    # Check ingress rule allows port 15002
    ingress_rules = connect_policy["spec"].get("ingress", [])
    assert len(ingress_rules) > 0, "spark-connect should have ingress rules"

    port_allowed = False
    for rule in ingress_rules:
        for port in rule.get("ports", []):
            if port.get("port") == 15002:
                port_allowed = True
                break

    assert port_allowed, "spark-connect policy should allow port 15002"

def test_network_explicit_allow_minio(helm_chart_path):
    """
    Validate explicit allow rules for MinIO access
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "minio.enabled=true",
        "--set", "networkPolicy.enabled=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))
    network_policies = [doc for doc in docs if doc.get("kind") == "NetworkPolicy"]

    # Find MinIO egress policy
    minio_policy = None
    for np in network_policies:
        if "minio" in np["metadata"]["name"] and "egress" in np["metadata"]["name"]:
            minio_policy = np
            break

    assert minio_policy is not None, "minio egress policy not found"

    # Check egress rule allows MinIO service
    egress_rules = minio_policy["spec"].get("egress", [])
    assert len(egress_rules) > 0, "minio egress policy should have rules"

    # Should allow traffic to MinIO port
    port_allowed = False
    for rule in egress_rules:
        for port in rule.get("ports", []):
            if port.get("port") in [9000, 9001]:  # MinIO API + Console
                port_allowed = True
                break

    assert port_allowed, "minio policy should allow ports 9000/9001"

def test_network_no_overly_permissive(helm_chart_path):
    """
    Validate no overly permissive network policies
    """
    cmd = [
        "helm", "template", "spark-3.5",
        helm_chart_path,
        "--set", "networkPolicy.enabled=true"
    ]

    result = subprocess.run(cmd, capture_output=True, text=True)
    assert result.returncode == 0

    docs = list(yaml.safe_load_all(result.stdout))
    network_policies = [doc for doc in docs if doc.get("kind") == "NetworkPolicy"]

    for np in network_policies:
        # Check for wildcard port ranges
        for rule in np["spec"].get("ingress", []) + np["spec"].get("egress", []):
            for port in rule.get("ports", []):
                if port.get("port") and isinstance(port["port"], dict):
                    # Check for overly broad range
                    start = port["port"].get("startPort", 0)
                    end = port["port"].get("endPort", 65535)
                    # Allow broad range only for specific cases
                    if end - start > 1000:
                        assert np["metadata"]["name"] in ["default-deny-egress"], \
                            f"Overly permissive port range in {np['metadata']['name']}: {start}-{end}"

        # Check for wildcard namespace selectors
        for rule in np["spec"].get("ingress", []) + np["spec"].get("egress", []):
            for peer in rule.get("from", []) + rule.get("to", []):
                ns_selector = peer.get("namespaceSelector", {})
                # Empty dict matches all namespaces - should be limited
                if ns_selector == {}:
                    # Only allow for specific cases
                    assert np["metadata"]["name"] in ["default-deny-ingress", "default-deny-egress"], \
                        f"Wildcard namespace selector in {np['metadata']['name']}"
```

### Scope Estimate

- Files: 6
- Lines: ~500 (MEDIUM)
- Tokens: ~4000

### Constraints

- DO use helm template + yaml parsing
- DO validate default-deny first
- DO check explicit allow rules
- DO NOT allow overly permissive policies

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 â€” âœ…

**Goal Achieved:** ______
