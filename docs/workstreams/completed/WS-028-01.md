---
ws_id: 028-01
feature: F28
status: completed
size: LARGE
project_id: 00
github_issue: null
assignee: null
depends_on: []
---

## WS-028-01: Unify Values Layout and Extract Shared Templates to spark-base

### Goal

**What must WORK after completing this WS:**
- Unified values structure for `core.postgresql` and `core.hiveMetastore` across spark-3.5 and spark-4.1
- `postgresql-deployment.yaml` and `hive-metastore-deployment.yaml` in `spark-base` consumed by both charts
- Only difference between charts: default database name (parameterized via `default` function)

**Acceptance Criteria:**
- [x] AC1: Design document: `docs/adr/ADR-028-unified-values-layout.md` — documents the target values structure
- [x] AC2: `charts/spark-base/values.yaml` extended with `core.postgresql` and `core.hiveMetastore` sections (matching spark-4.1 layout)
- [x] AC3: `charts/spark-base/templates/core/postgresql-deployment.yaml` parameterized with chart-agnostic naming (fullname helper from parent chart via `.Chart.Name`)
- [x] AC4: `charts/spark-base/templates/core/hive-metastore-deployment.yaml` extracted, default database name passed from parent chart values
- [x] AC5: `charts/spark-4.1/templates/core/postgresql-deployment.yaml` REMOVED (consumed from spark-base)
- [x] AC6: `charts/spark-3.5/templates/core/postgresql-deployment.yaml` REMOVED (consumed from spark-base)
- [x] AC7: `helm template test charts/spark-4.1` output matches before/after (except resource naming)
- [x] AC8: `helm template test charts/spark-3.5` output matches before/after (except resource naming)
- [x] AC9: All existing tests pass

### Context (from oneshot-F028 agent)

The previous agent (oneshot-F028-2026-02-13) correctly identified that values layouts differ:
- spark-4.1: `core.postgresql`, `core.hiveMetastore`
- spark-3.5: `core.postgresql`, `core.hiveMetastore` (same!) BUT also has legacy `hiveMetastore` at root
- spark-base: `postgresql` (flat, different path)

**Resolution approach:**
1. Standardize on `core.*` layout (already used by both 3.5 and 4.1)
2. Move spark-base to `core.*` namespace (breaking change for spark-base standalone users — document in ADR)
3. Templates in spark-base use `{{ .Values.core.postgresql.* }}` path
4. Only difference: default database name — use `{{ .Values.core.hiveMetastore.database.name | default "metastore" }}` (no version suffix in template, let values set the name)
5. Legacy `hiveMetastore` root key in spark-3.5 values — keep for backward compat, but primary rendering uses `core.hiveMetastore`

### Risks

- **Breaking change** for anyone using `spark-base` standalone with `postgresql.*` path → document migration in ADR
- **Dual hive-metastore** paths in spark-3.5 (`core.hiveMetastore` + `hiveMetastore`) → phase out root-level in future WS

### Files Changed

- `docs/adr/ADR-028-unified-values-layout.md` (NEW)
- `charts/spark-base/values.yaml` (UPDATE: add `core.postgresql`, `core.hiveMetastore`)
- `charts/spark-base/templates/core/postgresql-deployment.yaml` (NEW: extracted from charts)
- `charts/spark-base/templates/core/hive-metastore-deployment.yaml` (NEW: extracted from charts)
- `charts/spark-base/templates/core/hive-metastore-service.yaml` (NEW: extracted)
- `charts/spark-base/templates/core/hive-metastore-configmap.yaml` (NEW: extracted)
- `charts/spark-4.1/templates/core/postgresql-deployment.yaml` (DELETE)
- `charts/spark-3.5/templates/core/postgresql-deployment.yaml` (DELETE)
- `charts/spark-4.1/templates/core/hive-metastore-deployment.yaml` (DELETE)
- `charts/spark-3.5/templates/core/hive-metastore-deployment.yaml` (DELETE if exists)

### Execution Report (2026-02-14)

- ADR-028 created; spark-base extended with `core.postgresql`, `core.hiveMetastore`, `rbac.serviceAccountName`
- Extracted to spark-base: postgresql-deployment, postgresql-service, hive-metastore-deployment, hive-metastore-configmap, hive-metastore-service
- Removed from spark-4.1: all 5 core templates; from spark-3.5: postgresql-deployment, postgresql-service
- Parent charts pass `core` via YAML anchor (`core: &core` … `spark-base.core: *core`) and `rbac.serviceAccountName`
- spark-3.5 spark-connect-configmap updated to use `spark.core.hiveMetastore.fullname` when core enabled
- `helm template` succeeds for both charts; phase2 integration tests pass
