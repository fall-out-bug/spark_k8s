---
ws_id: 028-02
feature: F28
status: completed
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on: ["028-01"]
---

## WS-028-02: Consolidate Intra-chart RBAC and Remove Legacy Hive-Metastore Duplicates

### Goal

**What must WORK after completing this WS:**
- Single RBAC source of truth in `templates/rbac/` directory
- No duplicate hive-metastore templates (root-level removed, core/ remains)
- KEDA templates clearly separated by purpose (operator vs connect)

**Acceptance Criteria:**
- [x] AC1: `templates/rbac.yaml` content merged into `templates/rbac/` directory:
  - Role + RoleBinding from `rbac.yaml` lines 1-33 → merge into `rbac/role.yaml` and `rbac/rolebinding.yaml`
  - ClusterRole + ClusterRoleBinding (Connect-specific) → `rbac/clusterrole.yaml` (NEW)
- [x] AC2: `templates/rbac.yaml` REMOVED after merge
- [x] AC3: `rbac/role.yaml` updated: combine permissions from both files (pods: add `update`, `deletecollection`; services: add `deletecollection`; add `persistentvolumeclaims`, `leases`)
- [x] AC4: `rbac/role.yaml` uses `{{ include "spark-4.1.fullname" . }}` naming (consistent with rest of chart)
- [x] AC5: `templates/hive-metastore.yaml` (279 LOC, uses `.Values.hiveMetastore`) REMOVED — replaced by `core/hive-metastore-deployment.yaml` (uses `.Values.core.hiveMetastore`)
- [x] AC6: `templates/hive-metastore-configmap.yaml` REMOVED — replaced by `core/hive-metastore-configmap.yaml`
- [x] AC7: KEDA templates: rename `templates/keda-scaledobject.yaml` → `templates/autoscaling/keda-operator-scaledobject.yaml` (clarify purpose: Spark Operator autoscaling)
- [x] AC8: `helm template` output is functionally equivalent before/after
- [x] AC9: All existing tests pass

### Context (from oneshot-F028 agent)

The agent correctly identified these are NOT simple duplicates:

**RBAC:** `rbac.yaml` has Role + RoleBinding + ClusterRole + ClusterRoleBinding (82 LOC, full permissions). `rbac/role.yaml` has Role only (35 LOC, minimal permissions). **Solution:** Merge the comprehensive version into the rbac/ directory structure, add ClusterRole as new file.

**KEDA:** `keda-scaledobject.yaml` targets `SparkApplication` (operator). `autoscaling/keda-scaledobject.yaml` targets `Deployment` (connect, S3-based). **Solution:** Keep both, rename for clarity.

**Hive-Metastore:** `hive-metastore.yaml` uses `.Values.hiveMetastore` (legacy). `core/hive-metastore-deployment.yaml` uses `.Values.core.hiveMetastore` (new). **Solution:** Remove legacy after WS-028-01 unifies values.

### Files Changed

- `charts/spark-4.1/templates/rbac/role.yaml` (UPDATE: merge full permissions)
- `charts/spark-4.1/templates/rbac/rolebinding.yaml` (UPDATE: use fullname helper)
- `charts/spark-4.1/templates/rbac/clusterrole.yaml` (NEW: extracted from rbac.yaml)
- `charts/spark-4.1/templates/rbac/clusterrolebinding.yaml` (NEW: extracted from rbac.yaml)
- `charts/spark-4.1/templates/rbac.yaml` (DELETE)
- `charts/spark-4.1/templates/hive-metastore.yaml` (DELETE)
- `charts/spark-4.1/templates/hive-metastore-configmap.yaml` (DELETE)
- `charts/spark-4.1/templates/keda-scaledobject.yaml` → `templates/autoscaling/keda-operator-scaledobject.yaml` (RENAME)

### Execution Report (2026-02-14)

- Merged rbac.yaml into rbac/: role.yaml, rolebinding.yaml, clusterrole.yaml, clusterrolebinding.yaml
- Role has full permissions (pods, services, configmaps, persistentvolumeclaims, leases)
- Removed rbac.yaml, hive-metastore.yaml, hive-metastore-configmap.yaml
- Renamed keda-scaledobject.yaml → autoscaling/keda-operator-scaledobject.yaml
- Updated NOTES.txt and network-policy.yaml for core.hiveMetastore
- helm template and 43 tests pass
