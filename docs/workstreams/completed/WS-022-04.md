---
ws_id: 022-04
feature: F07
status: backlog
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 022-03
---

## WS-022-04: Create PSS/SCC Smoke Tests

### üéØ Goal

**What must WORK after completing this WS:**
- 8 security smoke —Ç–µ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω—ã (4 PSS + 4 SCC)
- scripts/tests/lib/security-validation.sh –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
- –í—Å–µ —Ç–µ—Å—Ç—ã —Å–ª–µ–¥—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É pattern —Å YAML frontmatter
- –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç PSS compliance –∏ SCC assignment

**Acceptance Criteria:**
- [ ] AC1: scripts/tests/security/pss-restricted-35.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC2: scripts/tests/security/pss-restricted-41.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC3: scripts/tests/security/pss-baseline-35.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC4: scripts/tests/security/pss-baseline-41.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC5: scripts/tests/security/scc-restricted-35.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC6: scripts/tests/security/scc-restricted-41.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC7: scripts/tests/security/scc-anyuid-35.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC8: scripts/tests/security/scc-anyuid-41.sh —Å–æ–∑–¥–∞–Ω
- [ ] AC9: scripts/tests/lib/security-validation.sh –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
- [ ] AC10: –í—Å–µ PSS —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç runAsNonRoot, seccompProfile, capabilities
- [ ] AC11: –í—Å–µ SCC —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç SCC assignment
- [ ] AC12: –í—Å–µ —Ç–µ—Å—Ç—ã –∏–º–µ—é—Ç YAML frontmatter

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### Context

Smoke tests –¥–ª—è validation PSS compliance –∏ OpenShift SCC assignment.

**8 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:**

| Scenario | Spark Version | PSS Profile | Platform |
|----------|---------------|-------------|----------|
| pss-restricted-35 | 3.5.x | restricted | K8s |
| pss-restricted-41 | 4.1.x | restricted | K8s |
| pss-baseline-35 | 3.5.x | baseline | K8s |
| pss-baseline-41 | 4.1.x | baseline | K8s |
| scc-restricted-35 | 3.5.x | restricted | OpenShift |
| scc-restricted-41 | 4.1.x | restricted | OpenShift |
| scc-anyuid-35 | 3.5.x | anyuid | OpenShift |
| scc-anyuid-41 | 4.1.x | anyuid | OpenShift |

### Dependencies

- WS-022-03: OpenShift Presets

### Input Files

- scripts/tests/smoke/scenarios/*.sh - reference patterns
- scripts/tests/lib/namespace.sh - test utilities

### Steps

1. **Create scripts/tests/lib/security-validation.sh**

   –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å validation —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
   ```bash
   #!/bin/bash
   # Security validation library

   validate_pss_restricted() {
       local pod_name=$1
       # Check runAsNonRoot
       # Check seccompProfile
       # Check capabilities
       # Check allowPrivilegeEscalation
   }

   validate_scc_restricted() {
       local pod_name=$1
       # Check SCC assignment
   }
   ```

2. **Create PSS test for Spark 3.5 restricted**

   scripts/tests/security/pss-restricted-35.sh:
   ```bash
   #!/bin/bash
   # @meta
   name: "pss-restricted-35"
   type: "security"
   description: "PSS restricted compliance for Spark 3.5"
   category: "pss"
   profile: "restricted"
   # @endmeta

   setup_test_environment
   deploy_spark
   validate_pss_compliance
   run_spark_job
   ```

3. **Create remaining 7 test scripts**

4. **Ensure YAML frontmatter in all tests**

### Code

```bash
#!/bin/bash
# scripts/tests/lib/security-validation.sh

# PSS restricted validation
validate_pss_restricted() {
    local pod_name=$1
    local namespace=${2:-default}

    echo "Validating PSS restricted for pod: $pod_name"

    # Check runAsNonRoot
    local run_as_non_root=$(kubectl get pod "$pod_name" -n "$namespace" -o jsonpath='{.spec.securityContext.runAsNonRoot}')
    if [[ "$run_as_non_root" != "true" ]]; then
        echo "FAIL: runAsNonRoot is not true"
        return 1
    fi

    # Check seccompProfile
    local seccomp_type=$(kubectl get pod "$pod_name" -n "$namespace" -o jsonpath='{.spec.securityContext.seccompProfile.type}')
    if [[ "$seccomp_type" != "RuntimeDefault" ]]; then
        echo "FAIL: seccompProfile.type is not RuntimeDefault"
        return 1
    fi

    # Check allowPrivilegeEscalation
    local allow_priv_esc=$(kubectl get pod "$pod_name" -n "$namespace" -o jsonpath='{.spec.containers[0].securityContext.allowPrivilegeEscalation}')
    if [[ "$allow_priv_esc" != "false" ]]; then
        echo "FAIL: allowPrivilegeEscalation is not false"
        return 1
    fi

    # Check capabilities.drop
    local caps_drop=$(kubectl get pod "$pod_name" -n "$namespace" -o jsonpath='{.spec.containers[0].securityContext.capabilities.drop}')
    if [[ "$caps_drop" != *"ALL"* ]]; then
        echo "FAIL: capabilities.drop does not include ALL"
        return 1
    fi

    echo "PASS: PSS restricted validation successful"
    return 0
}

# SCC restricted validation (OpenShift)
validate_scc_restricted() {
    local pod_name=$1
    local namespace=${2:-default}

    echo "Validating SCC restricted for pod: $pod_name"

    # Check SCC assignment via annotations
    local scc_name=$(kubectl get pod "$pod_name" -n "$namespace" -o jsonpath='{.metadata.annotations.openshift\.io/scc}')
    if [[ "$scc_name" != *"restricted"* ]]; then
        echo "FAIL: Pod not assigned to restricted SCC"
        return 1
    fi

    echo "PASS: SCC restricted validation successful"
    return 0
}
```

```bash
#!/bin/bash
# scripts/tests/security/pss-restricted-35.sh

# @meta
name: "pss-restricted-35"
type: "security"
description: "PSS restricted compliance for Spark 3.5"
category: "pss"
profile: "restricted"
# @endmeta

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../scripts/tests/lib/security-validation.sh
source "${SCRIPT_DIR}/../lib/security-validation.sh"

CHART="${CHART:-charts/spark-3.5}"
RELEASE_NS="pss-restricted-35-test"
RELEASE_NAME="spark-35-pss-test"

cleanup() {
    echo "Cleaning up..."
    helm uninstall "$RELEASE_NAME" -n "$RELEASE_NS" 2>/dev/null || true
    kubectl delete namespace "$RELEASE_NS" 2>/dev/null || true
}

trap cleanup EXIT

setup_test_environment() {
    echo "Setting up test environment..."
    kubectl create namespace "$RELEASE_NS" --dry-run=client -o yaml | kubectl apply -f -
}

deploy_spark() {
    echo "Deploying Spark 3.5 with PSS restricted..."
    helm upgrade --install "$RELEASE_NAME" "$CHART" \
        -n "$RELEASE_NS" \
        --set security.createNamespace=true \
        --set security.pssProfile=restricted \
        --set security.podSecurityStandards=true \
        --set connect.enabled=true \
        --set connect.replicas=1 \
        --wait
}

validate_pss_compliance() {
    echo "Validating PSS compliance..."

    # Wait for pod to be ready
    local pod_name
    pod_name=$(kubectl get pods -n "$RELEASE_NS" -l app.kubernetes.io/component=connect -o jsonpath='{.items[0].metadata.name}')

    echo "Checking pod: $pod_name"
    kubectl wait --for=condition=ready pod "$pod_name" -n "$RELEASE_NS" --timeout=120s

    validate_pss_restricted "$pod_name" "$RELEASE_NS"
}

run_spark_job() {
    echo "Running test Spark job..."
    # Basic connectivity test
    kubectl exec -n "$RELEASE_NS" "$pod_name" -- spark-shell --version
}

main() {
    setup_test_environment
    deploy_spark
    validate_pss_compliance
    run_spark_job
    echo "All tests passed!"
}

main
```

### Expected Outcome

- 8 security smoke —Ç–µ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω—ã
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ security-validation.sh —Å reusable —Ñ—É–Ω–∫—Ü–∏—è–º–∏
- –í—Å–µ —Ç–µ—Å—Ç—ã —Å–ª–µ–¥—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É pattern

### Scope Estimate

- Files: 9 (8 tests + 1 library)
- Lines: ~600 (MEDIUM)
- Tokens: ~9000

### Completion Criteria

```bash
# Run all PSS tests
for script in scripts/tests/security/pss-*.sh; do
    echo "Running $script..."
    bash "$script"
done

# Run all SCC tests (requires OpenShift cluster)
for script in scripts/tests/security/scc-*.sh; do
    echo "Running $script..."
    bash "$script"
done

# Verify YAML frontmatter
grep -l "@meta" scripts/tests/security/*.sh | wc -l  # Should be 8

# Verify library functions exist
grep -q "validate_pss_restricted" scripts/tests/lib/security-validation.sh
grep -q "validate_scc_restricted" scripts/tests/lib/security-validation.sh
```

### Constraints

- DO NOT skip existing smoke test patterns
- DO NOT hardcode pod names - use labels
- DO ensure proper cleanup in trap handlers
- DO NOT create tests that require external dependencies

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC12 ‚Äî ‚úÖ

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
08fb889 feat(security): add PSS/SCC support and OpenShift presets (F07)

---

### Review Result

**Reviewed by:** Cursor Composer
**Date:** 2026-02-10

#### üéØ Goal Status

- [x] AC1-AC8: 8 security scripts (pss-*, scc-*) ‚Äî ‚úÖ
- [x] AC9: security-validation.sh ‚Äî ‚úÖ
- [x] AC10-AC12: PSS/SCC checks, YAML frontmatter ‚Äî ‚úÖ

**Goal Achieved:** ‚úÖ YES

#### Metrics Summary

| Check | Target | Actual | Status |
|-------|--------|--------|--------|
| Goal Achievement | 100% | 12/12 AC | ‚úÖ |
| Security scripts | 8 | pss-*4, scc-*4 | ‚úÖ |
| security-validation.sh | exists | validate_pss_restricted, validate_scc_restricted | ‚úÖ |
| bash -n syntax | pass | 8/8 | ‚úÖ |
| @meta frontmatter | 8 | 8 | ‚úÖ |

#### Verdict

‚úÖ APPROVED
