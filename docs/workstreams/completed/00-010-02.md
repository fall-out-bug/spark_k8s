---
ws_id: 00-010-02
feature: F10
status: completed
size: MEDIUM
project_id: 00
github_issue: null
assignee: null
depends_on:
  - 00-009-02  # Python 3.10 base layer
---

## WS-00-010-02: Python dependencies layer + test

### ðŸŽ¯ Goal

**What must WORK after completing this WS:**
- Python dependencies intermediate layer
- Organized requirements.txt (base, gpu, iceberg)
- Layer caching for fast rebuilds
- Unit tests validate library imports

**Acceptance Criteria:**
- [ ] AC1: docker/docker-intermediate/python-deps/Dockerfile created
- [ ] AC2: Extends spark-k8s-python-3.10:latest
- [ ] AC3: requirements.txt with base dependencies
- [ ] AC4: requirements-gpu.txt with RAPIDS deps
- [ ] AC5: requirements-iceberg.txt with Iceberg deps
- [ ] AC6: tests pass for all variants

**âš ï¸ WS is NOT complete until Goal is achieved (all AC âœ…).**

---

### Context

Python libraries (pandas, numpy, pyarrow, etc.) are needed for Jupyter and MLflow. This WS creates an intermediate layer with common dependencies.

### Dependencies

- WS-009-02: Python 3.10 base layer

### Input Files

- docker/docker-base/python-3.10/Dockerfile

### Steps

1. **Create requirements files**
2. **Create Dockerfile with layer caching**
3. **Create test script**
4. **Add to Makefile**

### Code

```dockerfile
# docker/docker-intermediate/python-deps/Dockerfile
ARG BASE_IMAGE=spark-k8s-python-3.10:latest
FROM ${BASE_IMAGE}

LABEL maintainer="spark-k8s"
LABEL description="Spark K8s - Python Dependencies Intermediate Layer"
LABEL version="1.0.0"

# Set working directory
WORKDIR /tmp

# Copy requirements files
COPY requirements-base.txt requirements-gpu.txt requirements-iceberg.txt /tmp/

# Install base dependencies (most common)
RUN pip install --no-cache-dir -r requirements-base.txt && \
    rm -rf /root/.cache/pip

# Create separate layers for GPU and Iceberg
# GPU dependencies (build in separate stage for optional inclusion)
ARG BUILD_GPU_DEPS=false
RUN if [ "$BUILD_GPU_DEPS" = "true" ]; then \
        pip install --no-cache-dir -r requirements-gpu.txt && \
        rm -rf /root/.cache/pip; \
    fi

# Iceberg dependencies (build in separate stage for optional inclusion)
ARG BUILD_ICEBERG_DEPS=false
RUN if [ "$BUILD_ICEBERG_DEPS" = "true" ]; then \
        pip install --no-cache-dir -r requirements-iceberg.txt && \
        rm -rf /root/.cache/pip; \
    fi

# Set working directory back to /opt
WORKDIR /opt

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD python -c "import pandas; import numpy" || exit 1

# Default shell
SHELL ["/bin/bash", "-c"]
```

```python
# requirements-base.txt
# Data processing
pandas>=2.0.0,<3.0.0
numpy>=1.24.0,<2.0.0
pyarrow>=12.0.0,<15.0.0

# SQL
pyspark>=3.5.0
sqlalchemy>=2.0.0
psycopg2-binary>=2.9.0

# ML/science
scikit-learn>=1.3.0
scipy>=1.10.0

# Utilities
requests>=2.28.0
urllib3>=2.0.0
```

```python
# requirements-gpu.txt
# RAPIDS (GPU-accelerated data science)
# Only installed if BUILD_GPU_DEPS=true
cudf>=23.0.0
cuml>=23.0.0
cupy>=12.0.0
```

```python
# requirements-iceberg.txt
# Apache Iceberg support
# Only installed if BUILD_ICEBERG_DEPS=true
pyiceberg>=0.6.0
fsspec>=2023.0.0
```

```bash
#!/bin/bash
# docker/docker-intermediate/test-python-deps.sh

set -e

IMAGE="${1:-spark-k8s-python-deps:latest}"

echo "Testing Python dependencies layer: $IMAGE"

# Test 1: Base dependencies
echo "Test 1: Check base dependencies"
docker build --build-arg BUILD_GPU_DEPS=false \
    --build-arg BUILD_ICEBERG_DEPS=false \
    -t "$IMAGE" -f Dockerfile . || {
    echo "FAIL: Build failed"
    exit 1
}

docker run --rm "$IMAGE" python -c "import pandas; print('pandas:', pandas.__version__)" || {
    echo "FAIL: pandas not importable"
    exit 1
}
echo "PASS: Base dependencies OK"

# Test 2: GPU dependencies (optional)
echo "Test 2: Check GPU dependencies (optional)"
docker build --build-arg BUILD_GPU_DEPS=true \
    --build-arg BUILD_ICEBERG_DEPS=false \
    -t "${IMAGE}-gpu" -f Dockerfile . 2>/dev/null || echo "SKIP: GPU build (expected without CUDA)"

# Test 3: Iceberg dependencies (optional)
echo "Test 3: Check Iceberg dependencies"
docker build --build-arg BUILD_GPU_DEPS=false \
    --build-arg BUILD_ICEBERG_DEPS=true \
    -t "${IMAGE}-iceberg" -f Dockerfile . || {
    echo "FAIL: Iceberg build failed"
    exit 1
}

docker run --rm "${IMAGE}-iceberg" python -c "import pyiceberg; print('pyiceberg:', pyiceberg.__version__)" || {
    echo "FAIL: pyiceberg not importable"
    exit 1
}
echo "PASS: Iceberg dependencies OK"

echo ""
echo "All tests passed! âœ…"
```

### Expected Outcome

- `docker/docker-intermediate/python-deps/` with Dockerfile and requirements files
- Test script
- Images for base, GPU, Iceberg variants

### Scope Estimate

- Files: 5
- Lines: ~600 (MEDIUM)
- Tokens: ~4500

### Constraints

- DO NOT include all dependencies in single layer (use build args)
- DO require WS-009-02 completion
- DO NOT exceed 500MB for base deps layer

---

## Execution Report

**Executed by:** ______
**Date:** ______
**Duration:** ______ minutes

### Goal Status
- [ ] AC1-AC6 â€” âœ…

**Goal Achieved:** ______

### Files Changed
| File | Action | LOC |
|------|--------|-----|
|      |        |     |

### Statistics
- **Files Changed:** ______
- **Lines Added:** ______
- **Lines Removed:** ______
- **Test Coverage:** ______ %
- **Tests Passed:** ______
- **Tests Failed:** ______

### Deviations from Plan
- ______

### Commit
______
