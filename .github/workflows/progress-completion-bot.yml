# WS-031-01: Workstream Completion Bot
# Comments on merge when docs/workstreams/completed/ changes
name: Progress Completion Bot

on:
  push:
    branches: [main, dev, master]
    paths:
      - 'docs/workstreams/completed/**'
  pull_request:
    types: [closed]
    paths:
      - 'docs/workstreams/completed/**'

jobs:
  completion-summary:
    name: Post completion summary
    runs-on: ubuntu-latest
    timeout-minutes: 2
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find completed workstreams
        id: parse
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ] && FILES="" || \
              FILES=$(git diff --name-only --diff-filter=A "$BEFORE" "$AFTER" -- 'docs/workstreams/completed/*.md' 2>/dev/null || true)
          else
            BASE="${{ github.event.pull_request.base.sha }}"
            MERGE="${{ github.event.pull_request.merge_commit_sha }}"
            FILES=$(git diff --name-only --diff-filter=A "$BASE" "$MERGE" -- 'docs/workstreams/completed/*.md' 2>/dev/null || true)
          fi
          if [ -z "$FILES" ]; then
            echo "count=0" >> $GITHUB_OUTPUT
            echo "summary=" >> $GITHUB_OUTPUT
            exit 0
          fi
          BUF=""
          for f in $FILES; do
            WS_ID=$(grep -E '^ws_id:' "$f" 2>/dev/null | head -1 | sed 's/ws_id:[[:space:]]*//' | tr -d '\r')
            FEATURE=$(grep -E '^feature:' "$f" 2>/dev/null | head -1 | sed 's/feature:[[:space:]]*//' | tr -d '\r')
            TITLE=$(grep -E '^## WS-' "$f" 2>/dev/null | head -1 | sed 's/^## WS-[^:]*:[[:space:]]*//' | tr -d '\r')
            BUF="${BUF}- **WS-${WS_ID}** (${FEATURE}): ${TITLE}\n"
          done
          COUNT=$(echo "$FILES" | wc -w)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BUF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post summary
        uses: actions/github-script@v7
        if: steps.parse.outputs.count != '0'
        with:
          script: |
            const count = '${{ steps.parse.outputs.count }}';
            const summary = `${{ steps.parse.outputs.summary }}`;
            const body = `## ðŸ“‹ Workstream Completion Summary

            ${count} workstream(s) completed:

            ${summary}

            _Generated by Progress Completion Bot_`;

            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            } else {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: body
              });
            }

      - name: Workflow summary
        if: always()
        run: |
          echo "## Progress Completion Bot" >> $GITHUB_STEP_SUMMARY
          echo "Completed: ${{ steps.parse.outputs.count || 0 }} workstream(s)" >> $GITHUB_STEP_SUMMARY
