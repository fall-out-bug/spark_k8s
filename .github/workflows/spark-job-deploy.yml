name: Spark Job Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Image version (git SHA)'
        required: true
      approval:
        description: 'Manager approval required for production'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io

jobs:
  promote-staging:
    name: Promote to Staging
    if: inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy to staging
        id: deploy
        run: |
          scripts/cicd/promote-job.sh \
            --environment staging \
            --image ${{ env.REGISTRY }}/spark-job:${{ inputs.version }} \
            --version ${{ inputs.version }}

      - name: Run integration tests
        id: integration-tests
        run: |
          scripts/tests/integration/run-integration-tests.sh --environment staging

      - name: Rollback on failure
        if: failure() && steps.deploy.outcome == 'success'
        run: |
          echo "::warning::Integration tests failed, initiating rollback..."

          scripts/cicd/rollback-job.sh \
            --environment staging \
            --previous \
            --wait || true

          # Alert team
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-type: application/json' \
              -d '{
                "text": "ðŸš¨ Auto-rollback triggered in staging",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Deployment Rollback*\n\nâ€¢ Environment: staging\nâ€¢ Version: ${{ inputs.version }}\nâ€¢ Reason: Integration tests failed"
                    }
                  }
                ]
              }' || true
          fi

  promote-production:
    name: Promote to Production
    if: inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy to production
        id: deploy
        run: |
          scripts/cicd/promote-job.sh \
            --environment production \
            --image ${{ env.REGISTRY }}/spark-job:${{ inputs.version }} \
            --version ${{ inputs.version }}

      - name: Wait for deployment
        id: wait
        run: |
          kubectl wait --for=condition=ready pod -l app=spark-job,version=${{ inputs.version }} -n spark-production --timeout=10m

      - name: Run production smoke tests
        id: smoke-tests
        run: |
          scripts/cicd/smoke-test-job.sh --environment production

      - name: Rollback on smoke test failure
        if: failure() && steps.deploy.outcome == 'success'
        run: |
          echo "::error::Smoke tests failed, initiating automatic rollback..."

          scripts/cicd/rollback-job.sh \
            --environment production \
            --previous \
            --wait || true

          # Alert team (always attempt)
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
              -H 'Content-type: application/json' \
              -d '{
                "text": "ðŸš¨ CRITICAL: Auto-rollback triggered in production",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ðŸš¨ Production Deployment Rollback*\n\nâ€¢ Environment: **production**\nâ€¢ Version: ${{ inputs.version }}\nâ€¢ Reason: Smoke tests failed\nâ€¢ Action: Automatic rollback initiated\n\n@channel Please investigate immediately."
                    }
                  }
                ]
              }' || true
          fi

          exit 1

      - name: Monitor for 30 minutes
        run: |
          scripts/cicd/monitor-deployment.sh --duration 30m

