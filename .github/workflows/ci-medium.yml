name: CI Medium

# Layer 2: Integration tests (<20 min)
# Consolidates: smoke-tests.yml, smoke-tests-parallel.yml
# Trigger: PR to main/dev + merge

on:
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.oneshot/**'
  push:
    branches: [main, dev]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  CLUSTER_NAME: spark-k8s-test

jobs:
  # Job 1: Smoke tests (kind cluster)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements-test.txt
          pip install pytest pytest-cov pytest-timeout pytest-html

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          version: v0.20.0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install Spark Operator
        run: |
          helm repo add spark-operator https://kubeflow.github.io/spark-operator
          helm repo update
          helm install spark-operator spark-operator/spark-operator \
            --namespace spark-operator \
            --create-namespace \
            --wait \
            --timeout 5m || true

      - name: Run smoke tests
        run: |
          pytest tests/unit/ tests/integration/ \
            -v \
            -k "not slow and not e2e" \
            --timeout=300 \
            --tb=short \
            || true

      - name: Run operations tests
        run: |
          pytest tests/operations/ -v --tb=short || true
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: |
          kubectl delete namespace spark-operator --ignore-not-found=true || true

  # Job 2: Critical scenarios (parallel)
  smoke-critical:
    name: Critical Scenarios
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-test.txt

      - name: Run critical tests
        run: |
          # Run autotuning tests (newly added)
          pytest scripts/autotuning/tests/ -v --tb=short || true

      - name: Validate Helm templates
        run: |
          helm template test charts/spark-3.5 \
            --set connect.enabled=true \
            --set monitoring.enabled=true \
            --debug || true

  # Job 3: Integration tests (after smoke)
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [smoke-tests]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-test.txt

      - name: Run integration tests
        run: |
          pytest tests/integration/ \
            -v \
            -k "not slow" \
            --timeout=300 \
            --tb=short \
            || true
        continue-on-error: true

  # Summary
  ci-medium-summary:
    name: CI Medium Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, smoke-critical, integration]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## CI Medium Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical Scenarios | ${{ needs.smoke-critical.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration.result }} |" >> $GITHUB_STEP_SUMMARY
