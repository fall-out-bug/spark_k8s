name: CI Fast

# Layer 1: Fast checks (<5 min)
# Consolidates: pr-validation.yml, code-validation.yml
# Trigger: Every PR (blocking)

on:
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.oneshot/**'
      - 'LICENSE'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Job 1: Lint (parallel matrix)
  lint:
    name: Lint (${{ matrix.tool }})
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        tool: [black, flake8, ruff]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-test.txt

      - name: Install lint tools
        run: pip install black flake8 ruff

      - name: Run ${{ matrix.tool }}
        run: |
          case "${{ matrix.tool }}" in
            black) black --check --diff . ;;
            flake8) flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics ;;
            ruff) ruff check . ;;
          esac

  # Job 2: Type checking (parallel)
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install mypy -r requirements-test.txt

      - name: Run MyPy
        run: mypy scripts/ --ignore-missing-imports || true
        continue-on-error: true

  # Job 3: Helm lint (parallel)
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Lint charts
        run: |
          helm lint charts/spark-3.5/ || true
          helm lint charts/spark-4.1/ || true
          helm lint charts/spark-base/ || true

  # Job 4: Unit tests (after lint passes)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements-test.txt
          pip install pytest pytest-cov pytest-timeout

      - name: Run unit tests
        run: |
          pytest tests/unit/ scripts/*/tests/ \
            -v \
            --tb=short \
            --timeout=120 \
            --cov=scripts \
            --cov-report=term-missing \
            --cov-fail-under=0 \
            || true  # Don't fail on coverage for now

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-fast
          path: |
            .coverage
            htmlcov/

  # Job 5: Security scan (parallel with unit tests)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install security tools
        run: pip install bandit[toml] safety

      - name: Run Bandit
        run: bandit -r scripts/ -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Run Safety
        run: safety check --json > safety-report.json || true
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # Job 6: PR validation (metadata checks)
  pr-checks:
    name: PR Metadata
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr.body || pr.body.length < 20) {
              core.warning('PR description is short. Consider adding more context.');
            }

      - name: Check for linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const issueRegex = /(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#\d+/gi;
            if (!issueRegex.test(pr.body || '')) {
              core.info('No linked issues found in PR description');
            }

      - name: Check file sizes
        run: |
          find . -name "*.py" -type f -exec wc -l {} \; | while read lines file; do
            if [ "$lines" -gt 300 ]; then
              echo "Warning: $file is $lines lines (recommended: <200)"
            fi
          done

  # Summary job
  ci-fast-summary:
    name: CI Fast Summary
    runs-on: ubuntu-latest
    needs: [lint, typecheck, helm-lint, unit-tests, security]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## CI Fast Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeCheck | ${{ needs.typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Lint | ${{ needs.helm-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Set status
        if: needs.lint.result == 'failure'
        run: exit 1
