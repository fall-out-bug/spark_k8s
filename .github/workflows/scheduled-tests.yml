name: Scheduled Full Test Suite

on:
  schedule:
    # Daily run at 1 AM UTC (9 PM MSK)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      run_smoke:
        description: 'Run smoke tests'
        required: false
        type: boolean
        default: true
      run_e2e:
        description: 'Run E2E tests'
        required: false
        type: boolean
        default: true
      run_load:
        description: 'Run load tests'
        required: false
        type: boolean
        default: true

# Cancel previous runs of the same workflow
concurrency:
  group: scheduled-tests
  cancel-in-progress: false

jobs:
  # Phase 1: Smoke Tests
  smoke-tests:
    name: Smoke Tests
    if: github.event.schedule != '' || github.event.inputs.run_smoke == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: spark-scheduled-smoke
          kubectl_version: v1.28.0

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Install dependencies
        run: |
          # Install GNU parallel for execution
          sudo apt-get update && sudo apt-get install -y parallel

      - name: Run parallel smoke tests
        run: |
          ./scripts/parallel/run_parallel.sh \
            --max-parallel 4 \
            --results-dir /tmp/smoke-results \
            --scenarios-dir scripts/tests/smoke/scenarios

      - name: Aggregate results
        if: always()
        run: |
          ./scripts/aggregate/aggregate_json.py \
            --input-dir /tmp/smoke-results \
            --output /tmp/smoke-results/aggregated.json

          ./scripts/aggregate/aggregate_junit.py \
            --input-dir /tmp/smoke-results \
            --output /tmp/smoke-results/junit.xml

      - name: Generate HTML report
        if: always()
        run: |
          ./scripts/aggregate/generate_html.py \
            --json-input /tmp/smoke-results/aggregated.json \
            --junit-input /tmp/smoke-results/junit.xml \
            --output /tmp/smoke-results/report.html

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: /tmp/smoke-results/
          retention-days: 30

      - name: Comment results on PR
        if: github.event_name == 'workflow_dispatch' && github.ref_type == 'branch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const aggregated = JSON.parse(fs.readFileSync('/tmp/smoke-results/aggregated.json', 'utf8'));
            const summary = `## Smoke Test Results
            - Total: ${aggregated.total}
            - Passed: ${aggregated.passed}
            - Failed: ${aggregated.failed}
            - Duration: ${aggregated.duration}s`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # Phase 2: E2E Tests
  e2e-tests:
    name: E2E Tests
    needs: smoke-tests
    if: always() && (needs.smoke-tests.result == 'success' || needs.smoke-tests.result == 'skipped') && (github.event.schedule != '' || github.event.inputs.run_e2e == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: spark-scheduled-e2e
          kubectl_version: v1.28.0

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Run E2E tests
        run: |
          ./scripts/run-e2e-tests.sh

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: tests/e2e/reports/
          retention-days: 30

  # Phase 3: Load Tests (smoke)
  load-tests-smoke:
    name: Load Tests (Smoke)
    needs: e2e-tests
    if: always() && (needs.e2e-tests.result == 'success' || needs.e2e-tests.result == 'skipped') && (github.event.schedule != '' || github.event.inputs.run_load == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r tests/load/requirements.txt

      - name: Run smoke load tests
        run: |
          pytest tests/load/test_multi_environment_load.py \
            -v \
            -m "not long_running" \
            --tb=short \
            --junitxml=/tmp/load-results/junit.xml

      - name: Upload load test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: /tmp/load-results/
          retention-days: 30

  # Summary Report
  summary:
    name: Test Summary Report
    needs: [smoke-tests, e2e-tests, load-tests-smoke]
    if: always() && github.event.schedule != ''
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/all-results

      - name: Generate summary report
        run: |
          echo "# Scheduled Test Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Smoke tests
          if [ -f "/tmp/all-results/smoke-test-results/aggregated.json" ]; then
            echo "## Smoke Tests" >> $GITHUB_STEP_SUMMARY
            cat /tmp/all-results/smoke-test-results/aggregated.json >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # E2E tests
          echo "## E2E Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Load tests
          echo "## Load Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create summary badge
        run: |
          # Calculate overall status
          if [[ "${{ needs.smoke-tests.result }}" == "success" ]] &&
             [[ "${{ needs.e2e-tests.result }}" == "success" ]] &&
             [[ "${{ needs.load-tests-smoke.result }}" == "success" ]]; then
            echo "status=passing" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          else
            echo "status=failing" >> $GITHUB_OUTPUT
            echo "color=failure" >> $GITHUB_OUTPUT
          fi
        id: status

      - name: Notify on failure
        if: steps.status.outputs.status == 'failing'
        run: |
          echo "## âŒ Test Suite Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more test phases failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
