name: CI Slow

# Layer 3: E2E and Load tests (>20 min)
# Consolidates: e2e-tests.yml, load-tests.yml, scheduled-tests.yml
# Trigger: Scheduled nightly + manual dispatch

on:
  schedule:
    # Nightly at 2 AM UTC
    - cron: '0 2 * * *'
  pull_request:
    branches: [main]
    paths:
      - 'charts/**'
      - 'scripts/**'
      - 'tests/e2e/**'
      - '.github/workflows/ci-slow.yml'
  workflow_dispatch:
    inputs:
      run_load_tests:
        description: 'Run load tests'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  CLUSTER_NAME: spark-e2e-test

jobs:
  # Job 1: E2E tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements-test.txt
          pip install pytest pytest-timeout pytest-html

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          version: v0.20.0
          config: .github/kind-config.yaml

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Setup cluster
        run: |
          # Install Spark Operator
          helm repo add spark-operator https://kubeflow.github.io/spark-operator
          helm install spark-operator spark-operator/spark-operator \
            --namespace spark-operator \
            --create-namespace \
            --wait \
            --timeout 10m || true

          # Install MinIO for S3 compatibility
          helm repo add minio https://charts.min.io/
          helm install minio minio/minio \
            --set mode=standalone \
            --set resources.requests.memory=512Mi \
            --set accessKey=${{ secrets.MINIO_ACCESS_KEY || 'minioadmin' }} \
            --set secretKey=${{ secrets.MINIO_SECRET_KEY || 'minioadmin' }} \
            --wait \
            --timeout 5m || true

      - name: Run E2E tests with retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 45
          max_attempts: 2
          retry_wait_seconds: 30
          command: |
            pytest tests/e2e/ \
              -v \
              --timeout=600 \
              --tb=short \
              --html=e2e-report.html \
              || true

      - name: Upload E2E report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report
          path: |
            e2e-report.html
            test-results/

      - name: Cleanup
        if: always()
        run: |
          kubectl delete namespace spark-operator --ignore-not-found=true || true
          kubectl delete namespace minio --ignore-not-found=true || true

  # Job 2: Load tests (optional, on schedule or manual)
  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-load-tests'))

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-test.txt

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: spark-load-test
          version: v0.20.0

      - name: Run load tests
        run: |
          pytest tests/load/ \
            -v \
            --timeout=1200 \
            --tb=short \
            || true
        continue-on-error: true

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results
          path: |
            load-results/
            benchmark-results.json

  # Job 3: Security scan (deep)
  security-deep:
    name: Deep Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Summary
  ci-slow-summary:
    name: CI Slow Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, load-tests, security-deep]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## CI Slow Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Load Tests | ${{ needs.load-tests.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Deep | ${{ needs.security-deep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
