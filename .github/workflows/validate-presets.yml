name: Validate Preset Values

on:
  pull_request:
    paths:
      - 'charts/**/values-scenario-*.yaml'
      - 'charts/**/templates/**'
  push:
    branches:
      - main
      - feature/spark-*

jobs:
  validate:
    name: Validate all preset values
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: latest

      - name: Validate Spark 4.1 presets
        run: |
          for values_file in charts/spark-4.1/values-scenario-*.yaml; do
            if [[ -f "${values_file}" ]]; then
              echo "Validating: ${values_file}"
              helm template test charts/spark-4.1 -f "${values_file}" --dry-run
            fi
          done

      - name: Validate Spark 3.5 spark-connect presets
        run: |
          for values_file in charts/spark-3.5/charts/spark-connect/values-scenario-*.yaml; do
            if [[ -f "${values_file}" ]]; then
              echo "   Validating: ${values_file}"
              helm template test charts/spark-3.5/charts/spark-connect -f "${values_file}" --dry-run
            fi
          done

      - name: Validate Spark 3.5 spark-standalone presets
        run: |
          for values_file in charts/spark-3.5/charts/spark-standalone/values-scenario-*.yaml; do
            if [[ -f "${values_file}" ]]; then
              echo "   Validating: ${values_file}"
              helm template test charts/spark-3.5/charts/spark-standalone -f "${values_file}" --dry-run
            fi
          done

      - name: Validate existing presets
        run: |
          echo "Validating existing presets..."
          helm template test charts/spark-3.5/charts/spark-standalone -f charts/spark-3.5/charts/spark-standalone/values-prod-like.yaml --dry-run

      - name: Run preset validation script
        run: |
          echo "Running preset validation..."
          ./scripts/validate-presets.sh || echo "⚠️ Validation script failed"

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: Install Conftest
        run: |
          go install github.com/open-policy-agent/conftest/latest@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Validate against OPA policies
        run: |
          echo "Running policy validation..."
          ./scripts/validate-policy.sh || echo "⚠️ Policy validation found issues"