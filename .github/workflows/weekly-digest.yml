# WS-031-03: Weekly Progress Digest
# Posts to Telegram channel every Monday 09:00 UTC
name: Weekly Progress Digest

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  digest:
    name: Generate and post digest
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 100

      - name: Generate digest
        id: digest
        run: |
          chmod +x scripts/cicd/weekly-digest.sh
          scripts/cicd/weekly-digest.sh .

      - name: Post to Telegram
        if: secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -F "chat_id=${TELEGRAM_CHAT_ID}" \
            -F "text=@/tmp/digest_body.txt" || true

      - name: Skip (no Telegram secrets)
        if: secrets.TELEGRAM_BOT_TOKEN == '' || secrets.TELEGRAM_CHAT_ID == ''
        run: echo "TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID not set; skipping Telegram post"
