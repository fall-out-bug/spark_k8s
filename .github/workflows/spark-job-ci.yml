name: Spark Job CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.11"
  SCALA_VERSION: "2.12"
  SPARK_VERSION: "3.5.0"

jobs:
  lint:
    name: Lint & Style Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python linting tools
        run: |
          pip install black flake8 pylint mypy

      - name: Run Black (Python formatter check)
        run: |
          black --check --diff .

      - name: Run Flake8 (Python linter)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Pylint
        run: |
          pylint **/*.py --exit-zero --output-format=colorized

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Bandit (Python security)
        run: |
          pip install bandit[toml]
          bandit -r . -f json -o bandit-report.json || true

      - name: Run Gitleaks (secret detection)
        uses: gitleaks/gitleaks-action@v2

      - name: Run Safety (dependency vulnerabilities)
        run: |
          pip install safety
          safety check --json > safety-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Run tests with coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4

  sql-validation:
    name: SQL Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5

      - name: Run SQL validation
        run: |
          scripts/cicd/validate-sql.sh

      - name: Analyze SQL query plans
        run: |
          scripts/cicd/analyze-sql-plan.sh

  dry-run:
    name: Dry-Run Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Helm dry-run
        run: |
          helm template spark-job ./charts/spark-job \
            --set job.image.tag=${{ github.sha }} \
            --dry-run \
            --debug

      - name: Validate manifests
        run: |
          kubectl apply --dry-run=server -f charts/spark-job/templates/

  build:
    name: Build & Push
    needs: [lint, security-scan, unit-tests, sql-validation, dry-run]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.REGISTRY_URL }}/spark-job:${{ github.sha }}
            ${{ secrets.REGISTRY_URL }}/spark-job:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-dev:
    name: Deploy to Dev
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Deploy to dev cluster
        run: |
          scripts/cicd/promote-job.sh \
            --environment dev \
            --image ${{ secrets.REGISTRY_URL }}/spark-job:${{ github.sha }} \
            --version ${{ github.sha }}

      - name: Verify deployment
        run: |
          kubectl wait --for=condition=ready pod -l app=spark-job,version=${{ github.sha }} -n spark-dev --timeout=5m

  smoke-tests:
    name: Smoke Tests
    needs: deploy-dev
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          scripts/cicd/smoke-test-job.sh --environment dev
